<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='line'>  1</span> <span class="COMM">/**
<span class='line'>  2</span>  * @description Class that builds a movie from a series of images when a button is clicked, and displays the video to the user.
<span class='line'>  3</span>  * @fileoverview Contains the definition of a class for generating and displaying movies.
<span class='line'>  4</span>  * @author &lt;a href="mailto:keith.hughitt@nasa.gov">Keith Hughitt&lt;/a>
<span class='line'>  5</span>  * @author Jaclyn Beck
<span class='line'>  6</span>  * 
<span class='line'>  7</span>  * Syntax: Prototype, jQuery ()
<span class='line'>  8</span>  */</span><span class="WHIT">
<span class='line'>  9</span> </span><span class="COMM">/*global Class, jQuery, $, $A, Ajax, Builder, Shadowbox, setTimeout, window */</span><span class="WHIT">
<span class='line'> 10</span> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">MovieBuilder</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Class.create</span><span class="PUNC">(</span><span class="WHIT">
<span class='line'> 11</span> </span><span class="WHIT">	</span><span class="COMM">/** @lends MovieBuilder.prototype */</span><span class="WHIT">
<span class='line'> 12</span> </span><span class="WHIT">    </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 13</span> 
<span class='line'> 14</span> </span><span class="WHIT">	</span><span class="COMM">/**
<span class='line'> 15</span> 	 * @constructs
<span class='line'> 16</span> 	 * @description Loads default options, grabs mediaSettings, sets up event listener for the movie button
<span class='line'> 17</span> 	 * @TODO Add error checking for startTime in case the user asks for a time that isn't in the database.
<span class='line'> 18</span> 	 * @param {Object} controller -- the helioviewer class 
<span class='line'> 19</span> 	 */</span><span class="WHIT">	
<span class='line'> 20</span> 	</span><span class="NAME">initialize</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">controller</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 21</span> </span><span class="WHIT">		</span><span class="NAME">Object.extend</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 22</span> </span><span class="WHIT">		</span><span class="NAME">this.url</span><span class="WHIT"> 		</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"api/index.php"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 23</span> </span><span class="WHIT">		</span><span class="NAME">this.controller</span><span class="WHIT">	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">controller</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 24</span> </span><span class="WHIT">		</span><span class="NAME">this.button</span><span class="WHIT">		</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">jQuery</span><span class="PUNC">(</span><span class="STRN">"#movie-button"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 25</span> </span><span class="WHIT">		</span><span class="NAME">this.viewport</span><span class="WHIT"> 	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.controller.viewport</span><span class="PUNC">;</span><span class="WHIT">	
<span class='line'> 26</span> 		
<span class='line'> 27</span> 		</span><span class="NAME">this.mediaSettings</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.controller.mediaSettings</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 28</span> </span><span class="WHIT">		</span><span class="NAME">this.building</span><span class="WHIT">	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 29</span> </span><span class="WHIT">		</span><span class="NAME">this.percent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 30</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">self</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 31</span> 
<span class='line'> 32</span> </span><span class="WHIT">		</span><span class="NAME">this.button.click</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">			
<span class='line'> 33</span> 			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">helioviewer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">self.controller</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">visibleCoords</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 34</span> 
<span class='line'> 35</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">self.building</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 36</span> </span><span class="WHIT">				</span><span class="NAME">self.mediaSettings.shadowboxWarn</span><span class="PUNC">(</span><span class="STRN">'Warning: Your movie is already being built. A link to view the movie will appear shortly.'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 37</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 38</span> 
<span class='line'> 39</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">self.building</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 40</span> </span><span class="WHIT">				</span><span class="NAME">visibleCoords</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">helioviewer.viewport.getHCViewportPixelCoords</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> 	
<span class='line'> 41</span> 				
<span class='line'> 42</span> 				</span><span class="COMM">// Check to see if the user wants more than 3 layers in their movie. If they do,</span><span class="WHIT">
<span class='line'> 43</span> </span><span class="WHIT">				</span><span class="COMM">// they will have to pick 3. </span><span class="WHIT">
<span class='line'> 44</span> </span><span class="WHIT">				</span><span class="COMM">// checkMovieLayers will start the building process when it is done checking.	</span><span class="WHIT">
<span class='line'> 45</span> </span><span class="WHIT">				</span><span class="NAME">self.checkMovieLayers</span><span class="PUNC">(</span><span class="NAME">visibleCoords</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 46</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 47</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 48</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'> 49</span> 
<span class='line'> 50</span> </span><span class="WHIT">	</span><span class="COMM">/**
<span class='line'> 51</span> 	 * @description Checks to make sure there are 3 or less layers in the movie. If there are more, user is presented with
<span class='line'> 52</span> 	 * 				pop-up in Shadowbox asking them to pick 3 layers.
<span class='line'> 53</span> 	 * @param {Object} self 
<span class='line'> 54</span> 	 * @param {Object} visibleCoords -- An array containing the top, left, bottom, right coordinates of:
<span class='line'> 55</span> 	 * 					 1) what is currently visible in the viewport, or
<span class='line'> 56</span> 	 * 					 2) a selected region within the viewport.
<span class='line'> 57</span> 	 * 					Note that these coordinates are heliocentric, with the center of the sun being (0,0).
<span class='line'> 58</span> 	 * 					
<span class='line'> 59</span> 	 */</span><span class="WHIT">
<span class='line'> 60</span> </span><span class="WHIT">	</span><span class="NAME">checkMovieLayers</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">visibleCoords</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 61</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">finalLayers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">$A</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">self</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">layers</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">table</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">info</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rawName</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">name</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">tableValues</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">checkboxes</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 62</span> </span><span class="WHIT">		
<span class='line'> 63</span> 		</span><span class="COMM">// Refresh settings in case something has changed.</span><span class="WHIT">
<span class='line'> 64</span> </span><span class="WHIT">		</span><span class="NAME">this.mediaSettings.getSettings</span><span class="PUNC">(</span><span class="NAME">visibleCoords</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">	
<span class='line'> 65</span> 		</span><span class="NAME">layers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.mediaSettings.layers</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 66</span> 
<span class='line'> 67</span> </span><span class="WHIT">		</span><span class="COMM">// If there are between 1 and 3 layers, continue building.</span><span class="WHIT">
<span class='line'> 68</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">layers.length</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">layers.length</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 69</span> </span><span class="WHIT">			</span><span class="NAME">this.buildMovie</span><span class="PUNC">(</span><span class="NAME">layers</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 70</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">	
<span class='line'> 71</span> 		
<span class='line'> 72</span> 		</span><span class="COMM">// Otherwise, prompt the user to pick 3 layers.</span><span class="WHIT">
<span class='line'> 73</span> </span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 74</span> </span><span class="WHIT">			</span><span class="NAME">self</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 75</span> </span><span class="WHIT">			</span><span class="NAME">Shadowbox.open</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 76</span> </span><span class="WHIT">				</span><span class="NAME">player</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="STRN">"html"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'> 77</span> </span><span class="WHIT">				</span><span class="NAME">width</span><span class="PUNC">:</span><span class="WHIT"> 	</span><span class="NUMB">450</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'> 78</span> </span><span class="WHIT">				</span><span class="COMM">// Adjust height depending on how much space the text takes up (roughly 20 pixels per layer name, and a base height of 150)</span><span class="WHIT">
<span class='line'> 79</span> </span><span class="WHIT">				</span><span class="NAME">height</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">150</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">layers.length</span><span class="WHIT"> </span><span class="PUNC">*</span><span class="WHIT"> </span><span class="NUMB">20</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'> 80</span> 
<span class='line'> 81</span> </span><span class="WHIT">				</span><span class="COMM">// Put an empty table into shadowbox. Rows of layers need to be dynamically added through javascript.</span><span class="WHIT">
<span class='line'> 82</span> </span><span class="WHIT">				</span><span class="NAME">content</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">'&lt;div id="shadowbox-form" class="ui-widget ui-widget-content ui-corner-all ui-helper-clearfix" style="margin: 10px; padding: 20px; font-size: 12pt;" >'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT">
<span class='line'> 83</span> </span><span class="WHIT">							</span><span class="STRN">'Please select only 3 layers from the choices below for the movie: &lt;br />'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT">
<span class='line'> 84</span> </span><span class="WHIT">							</span><span class="STRN">'&lt;table id="layers-table">'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> 
<span class='line'> 85</span> 							</span><span class="STRN">'&lt;/table>'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> 
<span class='line'> 86</span> 							</span><span class="STRN">'&lt;div id="buttons" style="text-align: left; float: right;">'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT">
<span class='line'> 87</span> </span><span class="WHIT">								</span><span class="STRN">'&lt;button id="ok-button" class="ui-state-default ui-corner-all">OK&lt;/button>'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT">
<span class='line'> 88</span> </span><span class="WHIT">							</span><span class="STRN">'&lt;/div>'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT">
<span class='line'> 89</span> </span><span class="WHIT">						</span><span class="STRN">'&lt;/div>'</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'> 90</span> </span><span class="WHIT">						
<span class='line'> 91</span> 				</span><span class="NAME">options</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 92</span> </span><span class="WHIT">					</span><span class="NAME">onFinish</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 93</span> 
<span class='line'> 94</span> </span><span class="WHIT">						</span><span class="NAME">table</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">$</span><span class="PUNC">(</span><span class="STRN">'layers-table'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 95</span> </span><span class="WHIT">						</span><span class="NAME">tableValues</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 96</span> </span><span class="WHIT">						
<span class='line'> 97</span> 						</span><span class="COMM">// Get a user-friendly name for each layer. each layer in "layers" is a string: </span><span class="WHIT">
<span class='line'> 98</span> </span><span class="WHIT">						</span><span class="COMM">// "obs,inst,det,meas,visible,opacity'x'XStart,XEnd,YStart,YEnd,offsetX,offsetY"	</span><span class="WHIT">
<span class='line'> 99</span> </span><span class="WHIT">						</span><span class="NAME">layers.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">l</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>100</span> </span><span class="WHIT">							</span><span class="NAME">info</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">l.split</span><span class="PUNC">(</span><span class="STRN">'x'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>101</span> </span><span class="WHIT">							</span><span class="COMM">// Extract the first part of the layer string (obs,inst,det,meas,visible,opacity) and slice off the last two values.</span><span class="WHIT">
<span class='line'>102</span> </span><span class="WHIT">							</span><span class="NAME">rawName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">info</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">','</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">slice</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">2</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>103</span> </span><span class="WHIT">							</span><span class="NAME">name</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">rawName.join</span><span class="PUNC">(</span><span class="STRN">" "</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>104</span> </span><span class="WHIT">							</span><span class="NAME">tableValues</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'&lt;tr>'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT">
<span class='line'>105</span> </span><span class="WHIT">									</span><span class="STRN">'&lt;td class="layers-checkbox">&lt;input type=checkbox name="layers" checked=true value="'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">l</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'"/>&lt;/td>'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT">
<span class='line'>106</span> </span><span class="WHIT">									</span><span class="STRN">'&lt;td class="layers-name">'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">name</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'&lt;/td>'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> 
<span class='line'>107</span> 								</span><span class="STRN">'&lt;/tr>'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>108</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">	
<span class='line'>109</span> 						
<span class='line'>110</span> 						</span><span class="NAME">table.innerHTML</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">tableValues</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>111</span> </span><span class="WHIT">						
<span class='line'>112</span> 						</span><span class="COMM">// Set up event handler for the button</span><span class="WHIT">
<span class='line'>113</span> </span><span class="WHIT">						</span><span class="NAME">jQuery</span><span class="PUNC">(</span><span class="STRN">'#ok-button'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">click</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>114</span> </span><span class="WHIT">							</span><span class="NAME">checkboxes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">jQuery</span><span class="PUNC">(</span><span class="STRN">'td.layers-checkbox'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>115</span> </span><span class="WHIT">							
<span class='line'>116</span> 							</span><span class="COMM">// checkboxes is an array of each &lt;td.layers-checkbox> that exists in the table</span><span class="WHIT">
<span class='line'>117</span> </span><span class="WHIT">							</span><span class="COMM">// "this" represents an individual element in the array.</span><span class="WHIT">
<span class='line'>118</span> </span><span class="WHIT">							</span><span class="COMM">// So "this" would be one &lt;td.layers-checkbox>, and this.firstChild is its &lt;input type=checkbox></span><span class="WHIT">
<span class='line'>119</span> </span><span class="WHIT">							</span><span class="NAME">checkboxes.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>120</span> </span><span class="WHIT">								</span><span class="COMM">// If the checkbox is selected, add that layer. The value is the full name of the layer as found in the array "layers".</span><span class="WHIT">
<span class='line'>121</span> </span><span class="WHIT">							    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.firstChild.checked</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>122</span> </span><span class="WHIT">									</span><span class="NAME">finalLayers.push</span><span class="PUNC">(</span><span class="NAME">this.firstChild.value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>123</span> </span><span class="WHIT">								</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>124</span> </span><span class="WHIT">							</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>125</span> 
<span class='line'>126</span> </span><span class="WHIT">							</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">finalLayers.length</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">finalLayers.length</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>127</span> </span><span class="WHIT">								</span><span class="NAME">self.buildMovie</span><span class="PUNC">(</span><span class="NAME">finalLayers</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>128</span> </span><span class="WHIT">								</span><span class="NAME">Shadowbox.close</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>129</span> </span><span class="WHIT">							</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>130</span> </span><span class="WHIT">							
<span class='line'>131</span> 							</span><span class="COMM">// If the user still hasn't entered a valid number of layers, keep the prompt open and warn them</span><span class="WHIT">
<span class='line'>132</span> </span><span class="WHIT">							</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>133</span> </span><span class="WHIT">								</span><span class="COMM">// clear out finalLayers and try again</span><span class="WHIT">
<span class='line'>134</span> </span><span class="WHIT">								</span><span class="NAME">finalLayers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">$A</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>135</span> </span><span class="WHIT">								</span><span class="NAME">self.controller.messageConsole.error</span><span class="PUNC">(</span><span class="STRN">"Please select between 1 and 3 layer choices."</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>136</span> </span><span class="WHIT">							</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>137</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>138</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>139</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>140</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>141</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>142</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">		
<span class='line'>143</span> 
<span class='line'>144</span> 	</span><span class="COMM">/**
<span class='line'>145</span> 	 * @description Uses the layers passed in to send an Ajax request to api.php, to have it build a movie.
<span class='line'>146</span> 	 * 				Upon completion, it displays a notification that lets the user click to view it in Shadowbox
<span class='line'>147</span> 	 * 				or download the high quality version. 
<span class='line'>148</span> 	 * @param {Object} self
<span class='line'>149</span> 	 * @param {Object} layers -- An array of layer strings in the format: "obs,inst,det,meas,visible,opacity'x'XStart,XEnd,YStart,YEnd,offsetX,offsetY"	
<span class='line'>150</span> 	 */</span><span class="WHIT">
<span class='line'>151</span> </span><span class="WHIT">	</span><span class="NAME">buildMovie</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">layers</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>152</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">helioviewer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.controller</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">self</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">hqFormat</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">mediaSettings</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">timeout</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">imgHeight</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">imgWidth</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">options</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">filename</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">xhr</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>153</span> 
<span class='line'>154</span> </span><span class="WHIT">		</span><span class="NAME">this.building</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">	
<span class='line'>155</span> 		</span><span class="NAME">mediaSettings</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.mediaSettings</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>156</span> 
<span class='line'>157</span> </span><span class="WHIT">		</span><span class="NAME">imgWidth</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">mediaSettings.width</span><span class="PUNC">;</span><span class="WHIT"> 
<span class='line'>158</span> 		</span><span class="NAME">imgHeight</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">mediaSettings.height</span><span class="PUNC">;</span><span class="WHIT"> 
<span class='line'>159</span> 
<span class='line'>160</span> 		</span><span class="NAME">hqFormat</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">mediaSettings.hqFormat</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>161</span> </span><span class="WHIT">		</span><span class="NAME">filename</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">mediaSettings.filename</span><span class="PUNC">;</span><span class="WHIT">	
<span class='line'>162</span> 
<span class='line'>163</span> 		</span><span class="COMM">/*
<span class='line'>164</span> 		 * timeout is calculated to estimate the amount of time a movie will take to build. From benchmarking, I estimated about 1 second 
<span class='line'>165</span> 		 * per layer, per frame, to be the general case. C2 and C3 layers sometimes take longer but this is a good general equation.
<span class='line'>166</span> 		 * It will need to be adjusted when the database scales up to account for the amount of time queries take.
<span class='line'>167</span> 		 * 
<span class='line'>168</span> 		 * A movie with 40 frames and 2 layers would then take 1000 ms * 2 layers * 40 frames = 80000 ms, or 80 seconds. Then we want to 
<span class='line'>169</span> 		 * divide that evenly over 100% so that each 1% gets added at regular intervals. so 80000 ms / 100 = 800 ms, or .8 seconds in between
<span class='line'>170</span> 		 * adding 1% to the progress counter.
<span class='line'>171</span> 		 */</span><span class="WHIT">
<span class='line'>172</span> </span><span class="COMM">//		timeout = (1000 * layerNames.length * self.numFrames) / 100; </span><span class="WHIT">
<span class='line'>173</span> </span><span class="COMM">//		self.percent  = 0;</span><span class="WHIT">
<span class='line'>174</span> </span><span class="COMM">//		self.updateProgress(timeout);	</span><span class="WHIT">
<span class='line'>175</span> 
<span class='line'>176</span> </span><span class="WHIT">		</span><span class="NAME">self</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>177</span> </span><span class="WHIT">		</span><span class="NAME">xhr</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Ajax.Request</span><span class="PUNC">(</span><span class="NAME">self.url</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>178</span> </span><span class="WHIT">			</span><span class="NAME">method</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">'POST'</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>179</span> </span><span class="WHIT">			</span><span class="NAME">parameters</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>180</span> </span><span class="WHIT">				</span><span class="NAME">action</span><span class="PUNC">:</span><span class="WHIT"> 	</span><span class="STRN">"buildMovie"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>181</span> </span><span class="WHIT">				</span><span class="NAME">layers</span><span class="PUNC">:</span><span class="WHIT"> 	</span><span class="NAME">layers.join</span><span class="PUNC">(</span><span class="STRN">"/"</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>182</span> </span><span class="WHIT">				</span><span class="NAME">startDate</span><span class="PUNC">:</span><span class="WHIT"> 	</span><span class="NAME">mediaSettings.startTime</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>183</span> </span><span class="WHIT">				</span><span class="NAME">timeStep</span><span class="PUNC">:</span><span class="WHIT"> 	</span><span class="NAME">mediaSettings.timeStep</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>184</span> </span><span class="WHIT">				</span><span class="NAME">zoomLevel</span><span class="PUNC">:</span><span class="WHIT"> 	</span><span class="NAME">mediaSettings.zoomLevel</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>185</span> </span><span class="WHIT">				</span><span class="NAME">numFrames</span><span class="PUNC">:</span><span class="WHIT"> 	</span><span class="NAME">mediaSettings.numFrames</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>186</span> </span><span class="WHIT">				</span><span class="NAME">frameRate</span><span class="PUNC">:</span><span class="WHIT"> 	</span><span class="NAME">mediaSettings.frameRate</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>187</span> </span><span class="WHIT">				</span><span class="NAME">edges</span><span class="PUNC">:</span><span class="WHIT"> 		</span><span class="NAME">mediaSettings.edgeEnhance</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>188</span> </span><span class="WHIT">				</span><span class="NAME">sharpen</span><span class="PUNC">:</span><span class="WHIT"> 	</span><span class="NAME">mediaSettings.sharpen</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>189</span> </span><span class="WHIT">				</span><span class="NAME">format</span><span class="PUNC">:</span><span class="WHIT"> 	</span><span class="NAME">hqFormat</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>190</span> </span><span class="WHIT">				</span><span class="NAME">imageSize</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="NAME">imgWidth</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">","</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">imgHeight</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>191</span> </span><span class="WHIT">				</span><span class="NAME">filename</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="NAME">filename</span><span class="WHIT">
<span class='line'>192</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>193</span> 
<span class='line'>194</span> </span><span class="WHIT">			</span><span class="NAME">onComplete</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">transport</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>195</span> </span><span class="WHIT">                </span><span class="NAME">jQuery</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">trigger</span><span class="PUNC">(</span><span class="STRN">'video-done'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>196</span> </span><span class="WHIT">     
<span class='line'>197</span> 	 			</span><span class="COMM">/* 
<span class='line'>198</span> 	 			 * Not using linkId any more because there are two now options in the same notification, so linkId.click() is no
<span class='line'>199</span> 				 * longer useful.           
<span class='line'>200</span> 				 * // Let user know that video is ready
<span class='line'>201</span>  				 * linkId = helioviewer.messageConsole.link('', 'Quick-Video ready! Click here to start watching.');
<span class='line'>202</span>  				 */</span><span class="WHIT">
<span class='line'>203</span> </span><span class="WHIT">				
<span class='line'>204</span> 				</span><span class="NAME">self.building</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>205</span> 
<span class='line'>206</span> </span><span class="WHIT">				</span><span class="COMM">// If the response is an error message instead of a url, show the message</span><span class="WHIT">
<span class='line'>207</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">transport.responseJSON</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>208</span> </span><span class="WHIT">					</span><span class="NAME">mediaSettings.shadowboxWarn</span><span class="PUNC">(</span><span class="NAME">transport.responseText</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>209</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">	
<span class='line'>210</span> 				
<span class='line'>211</span> 				</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>212</span> </span><span class="WHIT">					</span><span class="COMM">// Options for the jGrowl notification. After it has opened, it will create event listeners for the download</span><span class="WHIT">
<span class='line'>213</span> </span><span class="WHIT">					</span><span class="COMM">// and watch links			</span><span class="WHIT">
<span class='line'>214</span> </span><span class="WHIT">					</span><span class="NAME">options</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>215</span> </span><span class="WHIT">						</span><span class="NAME">sticky</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>216</span> </span><span class="WHIT">						</span><span class="NAME">open</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>217</span> </span><span class="WHIT">							</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">hqfile</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">download</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">watch</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>218</span> </span><span class="WHIT">							</span><span class="COMM">// chop off the flv at the end of the file and replace it with mov/asf/mp4</span><span class="WHIT">
<span class='line'>219</span> </span><span class="WHIT">							</span><span class="NAME">hqfile</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">transport.responseJSON</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">slice</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">3</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">hqFormat</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>220</span> </span><span class="WHIT">							
<span class='line'>221</span> 							</span><span class="NAME">download</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">jQuery</span><span class="PUNC">(</span><span class="STRN">'#download-'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">filename</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>222</span> </span><span class="WHIT">							</span><span class="NAME">watch</span><span class="WHIT">	 </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">jQuery</span><span class="PUNC">(</span><span class="STRN">'#watch-'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">filename</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>223</span> 
<span class='line'>224</span> </span><span class="WHIT">							</span><span class="COMM">// Download the hq file event listener</span><span class="WHIT">
<span class='line'>225</span> </span><span class="WHIT">							</span><span class="NAME">download.click</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>226</span> </span><span class="WHIT">								</span><span class="NAME">window.open</span><span class="PUNC">(</span><span class="STRN">'api/index.php?action=downloadFile&url='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">hqfile</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'_parent'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>227</span> </span><span class="WHIT">							</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>228</span> </span><span class="WHIT">							
<span class='line'>229</span> 							</span><span class="COMM">// Open shadowbox and display movie event listener</span><span class="WHIT">
<span class='line'>230</span> </span><span class="WHIT">							</span><span class="NAME">watch.click</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>231</span> </span><span class="WHIT">								</span><span class="NAME">self.playMovie</span><span class="PUNC">(</span><span class="NAME">helioviewer</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">imgWidth</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">imgHeight</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">transport</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>232</span> </span><span class="WHIT">							</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>233</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>234</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>235</span> 
<span class='line'>236</span> </span><span class="WHIT">					</span><span class="COMM">// Make the jGrowl notification with the options above.</span><span class="WHIT">
<span class='line'>237</span> </span><span class="WHIT">					</span><span class="NAME">helioviewer.messageConsole.info</span><span class="PUNC">(</span><span class="STRN">"&lt;div id='watch-"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">filename</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"' style='cursor: pointer'>Click here to watch '"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">filename</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"'&lt;/div>"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT">
<span class='line'>238</span> </span><span class="WHIT">						</span><span class="STRN">"-or-&lt;br />"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> 
<span class='line'>239</span> 						</span><span class="STRN">"&lt;div id='download-"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">filename</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"' style='cursor: pointer'>Click here to download a high-quality version.&lt;/div>"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">options</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>240</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"> 
<span class='line'>241</span> 			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>242</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> 
<span class='line'>243</span> 	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> 
<span class='line'>244</span> 
<span class='line'>245</span> 	</span><span class="COMM">/**
<span class='line'>246</span> 	 * @description Calculates what dimensions the image has, whether to scale it or not, and how big Shadowbox should be. 
<span class='line'>247</span> 	 * 				Opens Shadowbox to play the movie.
<span class='line'>248</span> 	 */</span><span class="WHIT">
<span class='line'>249</span> </span><span class="WHIT">	</span><span class="NAME">playMovie</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">helioviewer</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">imgWidth</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">imgHeight</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">transport</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>250</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">url</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">vpWidth</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">vpHeight</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">vpDimensions</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sbHeight</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sbWidth</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>251</span> </span><span class="WHIT">		
<span class='line'>252</span> 		</span><span class="NAME">vpDimensions</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">helioviewer.viewport.getDimensions</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>253</span> </span><span class="WHIT">		</span><span class="NAME">vpWidth</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">vpDimensions.width</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>254</span> </span><span class="WHIT">		</span><span class="NAME">vpHeight</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">vpDimensions.height</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>255</span> </span><span class="WHIT">		
<span class='line'>256</span> 		</span><span class="COMM">// Scale to 80% if the movie size is too large to display without scrollbars.</span><span class="WHIT">
<span class='line'>257</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">imgWidth</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NAME">vpWidth</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">imgHeight</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NAME">vpHeight</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>258</span> </span><span class="WHIT">			</span><span class="NAME">imgWidth</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">imgWidth</span><span class="WHIT"> </span><span class="PUNC">*</span><span class="WHIT"> </span><span class="NUMB">0.8</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>259</span> </span><span class="WHIT">			</span><span class="NAME">imgHeight</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">imgHeight</span><span class="WHIT"> </span><span class="PUNC">*</span><span class="WHIT"> </span><span class="NUMB">0.8</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>260</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>261</span> </span><span class="WHIT">		
<span class='line'>262</span> 		</span><span class="NAME">url</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'api/index.php?action=playMovie&url='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">transport.responseJSON</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'&width='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">imgWidth</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'&height='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">imgHeight</span><span class="PUNC">;</span><span class="WHIT">	
<span class='line'>263</span> 		
<span class='line'>264</span> 		</span><span class="COMM">// 40 seems to be a good size for the iframe to completely surround the div. Can be changed if necessary.</span><span class="WHIT">
<span class='line'>265</span> </span><span class="WHIT">		</span><span class="NAME">sbWidth</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">imgWidth</span><span class="WHIT">  </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">40</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>266</span> </span><span class="WHIT">		</span><span class="NAME">sbHeight</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">imgHeight</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">40</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>267</span> </span><span class="WHIT">		
<span class='line'>268</span> 		</span><span class="COMM">// 7-13-2009 -- Changed the player from 'iframe' to 'html' so that the movie could be surrounded by nice rounded corners and transparent border.</span><span class="WHIT">
<span class='line'>269</span> </span><span class="WHIT">		</span><span class="NAME">Shadowbox.open</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>270</span> </span><span class="WHIT">			</span><span class="NAME">player</span><span class="WHIT">	</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">'html'</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>271</span> </span><span class="WHIT">			</span><span class="NAME">title</span><span class="WHIT">	</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">'Helioviewer Movie Player'</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>272</span> </span><span class="WHIT">			</span><span class="NAME">height</span><span class="WHIT">	</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">sbHeight</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">45</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>273</span> </span><span class="WHIT">			</span><span class="NAME">width</span><span class="WHIT">	</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">sbWidth</span><span class="WHIT">  </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">40</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>274</span> </span><span class="WHIT">			</span><span class="NAME">content</span><span class="WHIT">	</span><span class="PUNC">:</span><span class="WHIT"> 	</span><span class="STRN">'&lt;div class="ui-corner-all ui-helper-clearfix" style="margin: 10px; padding: 10px; background: black">'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> 
<span class='line'>275</span> 							</span><span class="STRN">'&lt;iframe src='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">url</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">' width='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">sbWidth</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">' height='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">sbHeight</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">' frameborder=0>'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> 
<span class='line'>276</span> 						</span><span class="STRN">'&lt;/div>'</span><span class="WHIT">
<span class='line'>277</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">									
<span class='line'>278</span> 	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">	
<span class='line'>279</span> 
<span class='line'>280</span> 	</span><span class="COMM">/**
<span class='line'>281</span> 	 * @description Displays a percentage, starting at 0, and increments it by one every &lt;timeout> seconds. It is here so users
<span class='line'>282</span> 	 * 				can tell something is going on. 
<span class='line'>283</span> 	 * @param {Object} timeout -- a value in miliseconds that was calculated in buildMovie as an estimate of how long the movie 
<span class='line'>284</span> 	 * 								will take to build / 100.
<span class='line'>285</span> 	 */</span><span class="WHIT">	
<span class='line'>286</span> 	</span><span class="NAME">updateProgress</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">timeout</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>287</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">self</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>288</span> </span><span class="WHIT">        
<span class='line'>289</span> 		</span><span class="COMM">// If 'video-done' is fired off, self.percent will e 101 so the next if statement will fail, and</span><span class="WHIT">
<span class='line'>290</span> </span><span class="WHIT">		</span><span class="COMM">// the process will stop.</span><span class="WHIT">
<span class='line'>291</span> </span><span class="WHIT">		</span><span class="NAME">jQuery</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="STRN">'video-done'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">self.percent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">101</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>292</span> </span><span class="WHIT">        
<span class='line'>293</span> 		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.percent</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>294</span> </span><span class="WHIT">			</span><span class="NAME">this.controller.messageConsole.progress</span><span class="PUNC">(</span><span class="STRN">'Movie loading: '</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.percent</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'%'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>295</span> </span><span class="WHIT">			</span><span class="NAME">this.percent</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>296</span> </span><span class="WHIT">			</span><span class="COMM">// call this function after &lt;timeout> seconds.</span><span class="WHIT">
<span class='line'>297</span> </span><span class="WHIT">			</span><span class="NAME">setTimeout</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">thisObj</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>298</span> </span><span class="WHIT">				</span><span class="NAME">thisObj.updateProgress</span><span class="PUNC">(</span><span class="NAME">timeout</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>299</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">timeout</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>300</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">	
<span class='line'>301</span> 	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>302</span> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>303</span> </span></pre></body></html>