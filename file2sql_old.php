<?php  set_time_limit(0);  ini_set('display_errors', 'On');    $GLOBALS['limit'] = 0;  $GLOBALS['count'] = 0;  $GLOBALS['cwd'] = str_replace('\\', '/', getcwd());    $dir = ($_GET['dir'] ? $_GET['dir'] : $_SERVER['argv'][1]);    if (!mysql_connect('localhost', 'helioviewer', 'helioviewer')) die ("error connecting to db");  mysql_select_db('esahelio_svdb0');    //header("Content-type: text/plain");  parseDir($dir);  echo "Insertion successful\n";  function parseDir($dir) {    $GLOBALS['count']++;    if ($GLOBALS['count'] == $GLOBALS['limit']) exit;    $hd = opendir($dir);    $imgs = array();    while ($entry = readdir($hd)) {      if ($entry == '.' || $entry == '..') continue;      if (is_dir("$dir/$entry")) parseDir("$dir/$entry");      elseif (substr($entry, -4) == '.jpg' || substr($entry, -4) == '.png') {        $imgs[] = "$dir/$entry";        //echo "Found tile: $dir/$entry\n";      }    }    closedir($hd);        sort($imgs);        $num = count($imgs);    if ($num > 0) {      $pathinfo = pathinfo($imgs[0]);      $filename = $pathinfo['basename'];      $extension = $pathinfo['extension'];      $map = substr($filename, 0, 34);      list($year, $month, $day, $time, $observatory, $instrument, $detector, $measurement) =        explode('_', $map);      $hour = substr($time, 0, 2);      $min = substr($time, 2, 2);      $sec = substr($time, 4, 2);            echo "Adding map $map...\n";      $query = sprintf("INSERT IGNORE INTO maps VALUES ('%s',                        '%s',                        %d, %d, %d, %d, %d, %d,                         '%s', '%s', '%s', '%s', '%s')",        mysql_real_escape_string($map),        "$year-$month-$day $hour:$min:$sec",        $year, $month, $day, $hour, $min, $sec,        $observatory, $instrument, $detector, $measurement, $extension      );      $result = mysql_query($query);      if (!$result) {        echo "$query - failed\n";        die (mysql_error());      }      //if (mysql_affected_rows()img > 0) {        echo "Adding tiles in $dir: ";        $c = 0;        $res = 10;        $next = 100 / $res;        foreach($imgs as $filepath) {          addImage($filepath);          $p = (int)($c / $num * 100);          if ($p >= $next) {            echo "$p% ";            $next += 100 / $res;          }          $c++;        }        echo "100%\n";      //}    }    unset($imgs);  }  function addImage($filepath) {  global $ratio;    $pathinfo = pathinfo($filepath);    $filename = $pathinfo['basename'];    $filetype = $pathinfo['extension'];    $map = substr($filename, 0, 34);    $zoom = substr($filename, 35, 2);    $x = substr($filename, 38, 2);    $y = substr($filename, 41, 2);    if ($x == 0 && $y == 0) {      $ratio = (float) substr($filename, 47, 7);    }    //echo "Adding tile: $filename\n";    //echo "$zoom, $x, $y, $ratio\n";    $query = sprintf("INSERT IGNORE INTO tilestore (map, zoom, x, y, tile, imgSunRatio, filetype) VALUES ('$map', $zoom, $x, $y, '%s', $ratio, '$filetype')", mysql_real_escape_string(file_get_contents($filepath)));    $result = mysql_query($query);    if (!$result) {      echo "$query - failed\n";      die (mysql_error());    }  }?>
