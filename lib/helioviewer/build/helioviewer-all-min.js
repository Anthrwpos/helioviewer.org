
var LoadingIndicator=Class.create();LoadingIndicator.prototype={initialize:function(){this.loadingItems=[];Ajax.Responders.register({onCreate:this.loadingStarted.bind(this,'Ajax'),onComplete:this.loadingFinished.bind(this,'Ajax')});},show:function(){$('loading').show();},hide:function(){$('loading').hide();},reset:function(){this.loadingItems.length=0;this.hide();},loadingStarted:function(item){this.show();this.loadingItems.push({});},loadingFinished:function(item){this.loadingItems.pop();if(this.loadingItems.length===0){this.hide();}}};var UIElement=Class.create({addObserver:function(eventName,callback){if(!this.observers){this.observers=[];}
if(!this.observers[eventName]){this.observers[eventName]=$A([]);}
this.observers[eventName].push(callback);return this;},fire:function(eventName,eventParameters){if(!this.observers||!this.observers[eventName]||this.observers[eventName].length===0){return this;}
this.observers[eventName].each(function(callback){callback(eventParameters);});return this;}});var Layer=Class.create(UIElement,{maxZoomLevel:20,minZoomLevel:10,visible:true,initialize:function(viewport){this.viewport=viewport;this.domNode=$(viewport.movingContainer.appendChild(new Element('div')));this.viewport.addObserver('move',this.viewportMove.bind(this));this.id='layer'+Math.floor(Math.random()*100000+1);},setZIndex:function(v){this.domNode.setStyle({zIndex:v});},setVisible:function(visible){this.visible=visible;this.domNode.setStyle({visibility:(visible?'visible':'hidden')});return this.visible;},toggleVisible:function(){return this.setVisible(!this.visible);}});var Calendar=Class.create(UIElement,{initialize:function(controller,dateFieldId,timeFieldId){this.controller=controller;this.dateField=$(dateFieldId);this.timeField=$(timeFieldId);var self=this;this.cal=jQuery("#"+dateFieldId).datepicker({buttonImage:'images/blackGlass/glass_button_calendar.png',buttonImageOnly:true,dateFormat:'yy/mm/dd',mandatory:true,showOn:'both',yearRange:'1998:2008',onSelect:function(dateStr){window.setTimeout(function(){var time=self.timeField.value;var date=Date.parse(dateStr);var hours=parseInt(time.substring(0,2));var minutes=parseInt(time.substring(3,5));var seconds=parseInt(time.substring(6,8));var utcDate=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate(),hours,minutes,seconds));self.fire('observationDateChange',utcDate);},500);}});},updateFields:function(){this.dateField.value=this.controller.date.toYmdUTCString();this.timeField.value=this.controller.date.toHmUTCString();}});var DataNavigator=Class.create(UIElement,{initialize:function(controller){this.controller=controller;this.data=new Hash();},query:function(type){var url='get'+type+'.php';var self=this;var xhr=new Ajax.Request(url,{parameters:{type:'json'},method:'get',onComplete:function(transport){self.data.set(type,transport.responseJSON);}});}});var Debug=Class.create();Debug.outputBuffer='';Debug.outputTimeout=null;Debug.loadingItemCount=0;Debug.loadingIndicator=new LoadingIndicator();Debug.test=function(xIndex,yIndex,level){xIndex=9;level=3;for(var l=0;l<=level;l++){var x=(xIndex>>(level-l+1))/(1<<l);var x2=1/(1<<l+1);Debug.output(x,(1<<l),(xIndex>>(level-l)),x2);}};Debug.output=function(){var txt='';for(var i=0;i<arguments.length;i++){txt+=arguments[i];if(i<arguments.length-1){txt+=', ';}}
if(window.console){window.console.log(txt);}else{if(Debug.outputTimeout){clearTimeout(Debug.outputTimeout);}
Debug.outputBuffer=txt+'\n'+Debug.outputBuffer;Debug.outputTimeout=setTimeout(Debug.flush,100);}};Debug.plotArray=function(a){Debug.output('----\n'+Debug.strArray(a,'',0));};Debug.strArray=function(a,indent,index){if(a instanceof Array){if(a.length===0){return indent+index+': []\n';}
var txt=indent+index+': [\n';var c=0;a.each(function(m){txt+=Debug.strArray(m,indent+'  ',c);++c;});return txt+indent+']\n';}else{return indent+index+': '+a+'\n';}};Debug.flush=function(){if($('debugOutput')){$('debugOutput').innerHTML='----\n'+Debug.outputBuffer+$('debugOutput').innerHTML;Debug.outputBuffer='';}};Debug.ajaxFailure=function(transport,url){Debug.output('Error getting file "'+url+'": '+transport.status+' '+transport.statusText);};var EventLayer=Class.create(Layer,{defaultOptions:{type:'EventLayer',sunRadius0:94*(1<<12),opacityGroupId:-1,displayLabels:false,windowSize:43200,eventMarkerOffset:{top:10,left:0}},initialize:function(viewport,options){Object.extend(this,this.defaultOptions);Object.extend(this,options);this.viewport=viewport;this.id='eventlayer'+new Date().getTime();this.events=$A([]);this.domNode=new Element('div',{className:'event-layer'});this.viewport.movingContainer.appendChild(this.domNode);this.eventAccordion.addLayer(this);this.queryEvents();},queryEvents:function(){var processResponse=function(transport){this.clear();if(transport.responseJSON){this.displayEvents(transport.responseJSON);}};var xhr=new Ajax.Request('getEvents.php',{method:'get',onSuccess:processResponse.bind(this),parameters:{task:'getPoi',date:this.viewport.controller.date.toISOString().slice(1,-1),windowSize:this.windowSize,catalogs:this.catalog}});},viewportMove:function(){},clear:function(){this.events.each(function(e){e.remove();});this.events.clear();},displayEvents:function(jsonEvents){var self=this;var date=this.viewport.controller.date;var UTCOffset=-parseInt(date.getTimezoneOffset())*60;var sunRadius=this.sunRadius0>>this.viewport.zoomLevel;jsonEvents.each(function(event){self.events.push(new EventMarker(self,event,date,UTCOffset,sunRadius,{offset:self.eventMarkerOffset}));});},toggleLabelVisibility:function(){this.displayLabels=!this.displayLabels;this.events.each(function(e){e.toggleLabel();});},reload:function(){this.queryEvents();},reset:function(){var sunRadius=this.sunRadius0>>this.viewport.zoomLevel;this.events.each(function(e){e.refresh(sunRadius);});}});var EventLayerAccordion=Class.create(Layer,{initialize:function(viewport,containerId){this.viewport=viewport;this.container=jQuery('#'+containerId);this._setupUI();this.domNode=jQuery('#EventLayerAccordion-Container');this.domNode.dynaccordion();this.getEventCatalogs();},addLayer:function(layer){var catalog=this.eventCatalogs.get(layer.catalog);var visibilityBtn="<button class='layerManagerBtn visible' id='visibilityBtn-"+layer.id+"' value=true type=button title='toggle layer visibility'></button>";var removeBtn="<button class='layerManagerBtn remove' id='removeBtn-"+layer.id+"' type=button title='remove layer'></button>";var head="<div class=layer-Head><span class=event-accordion-header-left>"+catalog.name+"</span><span class=event-accordion-header-right>"+visibilityBtn+removeBtn+"</span></div>";var body='<div style="color: white;">'+catalog.description+'</div>';this.domNode.dynaccordion("addSection",{id:layer.id,header:head,cell:body});this._setupEventHandlers(layer);},getEventCatalogs:function(){var self=this;var url="getEvents.php";jQuery.getJSON(url,function(catalogs){var lm=self.viewport.controller.layerManager;self.eventCatalogs=new Hash();catalogs.each(function(catalog){self.eventCatalogs.set(catalog.id,catalog);if(catalog.id!=="EITPlanningService::EITActivity"){if(catalog.id=="VSOService::noaa")
lm.addLayer(new EventLayer(self.viewport,{catalog:catalog.id,eventAccordion:self,windowSize:86400}));else
lm.addLayer(new EventLayer(self.viewport,{catalog:catalog.id,eventAccordion:self}));}});});},_setupUI:function(){var title=jQuery('<span>Events</span>').css({'float':'left','color':'black','font-weight':'bold'});this.container.append(jQuery('<div></div>').css('text-align','right').append(title).append('<br>'));var innerContainer=jQuery('<ul id=EventLayerAccordion></ul>');var outerContainer=jQuery('<div id="EventLayerAccordion-Container"></div>').append(innerContainer);this.container.append(outerContainer);},_setupEventHandlers:function(layer){visibilityBtn=jQuery("#visibilityBtn-"+layer.id);removeBtn=jQuery("#removeBtn-"+layer.id);var toggleVisibility=function(e){var visible=layer.toggleVisible();var icon=(visible?'LayerManagerButton_Visibility_Visible.png':'LayerManagerButton_Visibility_Hidden.png');jQuery("#visibilityBtn-"+layer.id).css('background','url(images/blackGlass/'+icon+')');e.stopPropagation();};var removeLayer=function(e){var self=e.data;self.viewport.controller.layerManager.removeLayer(layer);self.domNode.dynaccordion('removeSection',{id:layer.id});e.stopPropagation();};visibilityBtn.bind('click',this,toggleVisibility);removeBtn.bind('click',this,removeLayer);}});var EventMarker=Class.create({initialize:function(eventLayer,event,date,utcOffset,sunRadius,options){Object.extend(this,event);Object.extend(this,options);this.eventLayer=eventLayer;this.appDate=date;this.utcOffset=utcOffset;this.sunRadius=sunRadius;var catalogs=eventLayer.eventAccordion.eventCatalogs;this.catalogName=catalogs.get(this.catalogId).name;this.type=catalogs.get(this.catalogId).eventType;this.pos={x:this.sunX*sunRadius,y:this.sunY*sunRadius}
this.container=this.eventLayer.domNode.appendChild(new Element('div',{className:'event',style:'left: '+(this.pos.x)+'px; top: '+(this.pos.y)+'px;'}));this.createMarker();this.createLabel();this.createPopup();},createMarker:function(){var cssId=this.catalogId.gsub('::',"_");var marker=new Element('div',{className:cssId+' '+this.type.gsub(' ','_')+' event-marker'});var self=this;marker.observe('click',function(event){self.togglePopup();});this.marker=marker;this.container.appendChild(marker);},createLabel:function(){var display=(this.eventLayer.displayLabels?"inline":"none");var labelText=null;switch(this.type){case"Active Region":labelText=this.eventId;break;case"CME":labelText=this.startTime;break;case"Type II Radio Burst":labelText=this.startTime;break;default:labelText=this.startTime;break;}
var eventDate=Date.parse(this.startTime.substr(0,19)).addSeconds(this.utcOffset);var timeDiff=eventDate.getTime()-this.appDate.getTime();var label=new Element('div',{className:'event-label'}).setStyle({'display':display}).insert(labelText);if(timeDiff<0){label.addClassName("timeBehind");}
else if(timeDiff>0){label.addClassName("timeAhead");}
this.label=label;this.container.appendChild(label);},createPopup:function(){var popup=new Element('div',{className:'event-popup tooltip-topleft-large',style:'display: none;'});var content="<div class='event-popup-container'>"+"<strong>"+this.type+" "+this.eventId+"</strong><br>"+"<p>"+this.catalogName+"</p><br>"+"<strong>start:</strong> "+this.startTime+"<br>"+"<strong>end:</strong> "+this.endTime+"<br><br>"+"<strong>Position Angle:</strong> "+this.polarCpa+"&deg; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+"<strong>Width:</strong> "+this.polarWidth+"&deg;<br>"+"<strong>Source:</strong> <a href='"+this.sourceUrl+"' class='event-url'>"+this.sourceUrl+"</a><br>"+"</div>";popup.update(content);var closeBtn=new Element('a',{className:'event-popup-close-btn'}).insert("x");closeBtn.observe('click',this.togglePopup.bind(this));popup.insert(closeBtn);this.popup=popup;this.container.appendChild(popup);},remove:function(){this.container.remove();},refresh:function(sunRadius){this.sunRadius=sunRadius;this.pos={x:this.sunX*sunRadius,y:this.sunY*sunRadius};this.container.setStyle({left:(this.pos.x-2)+'px',top:(this.pos.y-2)+'px'});},toggleLabel:function(){this.label.toggle();},togglePopup:function(){this.popup.toggle();}});var Helioviewer=Class.create({defaultOptions:{defaultZoomLevel:12,defaultPrefetchSize:0,timeIncrementSecs:86400,minZoomLevel:9,maxZoomLevel:20,tileUrlPrefix:'getTile.php',imageUrlPrefix:'getImage.php',eventUrlPrefix:'getEvents.php'},date:new Date(Date.UTC(2003,9,5)),sources:{events:{noaa:{enabled:true},goes:{enabled:true},rhessi:{enabled:true}}},initialize:function(options){Object.extend(this,this.defaultOptions);Object.extend(this,options);this.dataNavigator=new DataNavigator(this);this.layerManager=new LayerManager(this);this.initViewports();this.initUI();this.initEvents();this.initKeyBoardListeners();this.layerManager.addLayer(new TileLayer(this.viewports[0],{tileUrlPrefix:this.tileUrlPrefix,observatory:'soho',instrument:'EIT',detector:'EIT',measurement:'304'}));this.layerManager.addLayer(new TileLayer(this.viewports[0],{tileUrlPrefix:this.tileUrlPrefix,observatory:'soho',instrument:'LAS',detector:'0C2',measurement:'0WL'}));},initUI:function(){this.calendar=new Calendar(this,'date','time');this.zoomControl=new ZoomControl(this,{id:'zoomControl',zoomLevel:this.defaultZoomLevel,minZoomLevel:this.minZoomLevel,maxZoomLevel:this.maxZoomLevel});this.timeStepSlider=new TimeStepSlider(this,'timestepHandle','timestepTrack','timeBackBtn','timeForwardBtn',this.timeIncrementSecs,8);this.messageConsole=new MessageConsole(this,'message-console','helioviewer-viewport-container-outer');this.tileLayerAccordion=new TileLayerAccordion(this.layerManager,'layerManager');this.eventLayerAccordion=new EventLayerAccordion(this.viewports[0],'eventAccordion');this.initToolTips();var centerBtn=Builder.node('div',{className:'center-button'},Builder.node('span',{},"center"));Event.observe(centerBtn,'click',this.viewports[0].center.bindAsEventListener(this.viewports[0]));this.viewports[0].innerNode.insert(centerBtn);},initViewports:function(){this.viewports=$A([new Viewport(this,{id:this.viewportId,zoomLevel:this.defaultZoomLevel,prefetch:this.defaultPrefetchSize,debug:false})]);var tileUrlPrefix=this.tileUrlPrefix;this.viewports.each(function(viewport){Event.observe(window,'resize',viewport.resize.bind(viewport));});},initEvents:function(){this.observe(this.zoomControl,'change',this.handlers.zoom);this.observe(this.calendar,'observationDateChange',this.handlers.observationDateChange);this.observe(this.timeStepSlider,'timeIncrementChange',this.handlers.timeIncrementChange);this.observe(this.layerManager,'newLayer',this.handlers.newLayer);Event.observe(this.calendar.timeField,'change',this.handlers.observationTimeChange.bindAsEventListener(this));},initKeyBoardListeners:function(){var self=this;Event.observe(document,'keypress',function(e){if(e.target.tagName!=="INPUT"){var code;if(!e)var e=window.event;if(e.keyCode)code=e.keyCode;else if(e.which)code=e.which;var character=String.fromCharCode(code);if(character==="-"||character==="_"){self.zoomControl.zoomButtonClicked(+1);}
else if(character==="="||character==="+"){self.zoomControl.zoomButtonClicked(-1);}
else if(character==="c"){self.viewports.each(function(viewport){viewport.center();});}
else if(character==="d"){self.layerManager.layers.each(function(layer){if(layer.type==="EventLayer"){layer.toggleLabelVisibility();}});}}});},initToolTips:function(){var items=$A(['#zoomControlZoomIn','#zoomControlZoomOut','#zoomControlHandle','#timestepHandle','#timeBackBtn','#timeForwardBtn']);var self=this;items.each(function(item){self.addToolTip(item,{yOffset:-125});});this.addToolTip('#movieBuilder',{position:'topleft'});},addToolTip:function(id,params){var options=params||[];var classname="tooltip-"+(options.position||"bottomleft")+"-"+(options.tooltipSize||"medium");jQuery(id).tooltip({delay:(options.delay?options.delay:1000),track:(options.track?options.track:false),showURL:false,opacity:1,fixPNG:true,showBody:" - ",extraClass:classname,top:(options.yOffset?options.yOffset:0),left:12});},addViewport:function(viewport){this.viewports.push(viewport);return this;},observe:function(uielement,eventName,eventHandler){uielement.addObserver(eventName,eventHandler.bind(this));},setDate:function(date){this.date=date;this.layerManager.reloadLayers();},handlers:{zoom:function(level){this.viewports.each(function(viewport){viewport.zoomTo(level);});},observationDateChange:function(date){this.setDate(date);this.calendar.updateFields();},observationTimeChange:function(e){var time=e.target.value;var regex=/^\d{2}:\d{2}:\d{2}?/;if(time.match(regex)){var newTime=time.split(':');var hours=parseInt(newTime[0],10)-this.date.getUTCHours();var mins=parseInt(newTime[1],10)-this.date.getUTCMinutes();var secs=parseInt(newTime[2],10)-this.date.getUTCSeconds();this.date.addHours(hours);this.date.addMinutes(mins);this.date.setSeconds(secs);this.setDate(this.date);this.layerManager.updateTimeStamps();}else{this.messageConsole.warn('Invalid time. Please enter a time in of form HH:MM:SS');}},timeIncrementChange:function(timeIncrement){this.timeStepSlider.setTimeIncrement(timeIncrement);},newToolTip:function(tooltip){this.addToolTip(tooltip.id,tooltip.params);},newLayer:function(data){var inst=data.instrument;var ui=data.menuEntry;var viewport=this.viewports[0];var layer=new TileLayer(viewport,{tileUrlPrefix:this.tileUrlPrefix,observatory:inst.observatory,instrument:inst.instrument,detector:inst.detector,measurement:inst.measurement});viewport.addLayer(layer);ui.layer=layer;ui.displayTileLayerOptions();}}});String.prototype.padLeft=function(padding,minLength){var str=this;var strPad=''+padding;while(str.length<minLength){str=strPad+str;}
return str;};String.prototype.trimLeft=function(padding){var str=this;var strPad=''+padding;while(str[0]===strPad){str=str.substr(1);}
return str;};Date.prototype.toYmdUTCString=function(){var year=this.getUTCFullYear()+'';var month=(this.getUTCMonth()+1)+'';var day=this.getUTCDate()+'';return year+'/'+month.padLeft(0,2)+'/'+day.padLeft(0,2);};Date.prototype.toHmUTCString=function(){var hour=this.getUTCHours()+'';var min=this.getUTCMinutes()+'';var sec=this.getUTCSeconds()+'';return hour.padLeft(0,2)+':'+min.padLeft(0,2)+':'+sec.padLeft(0,2);};Date.prototype.toUTCDate=function(){var utcOffset=this.getUTCOffset();var sign=utcOffset[0];var hours=parseInt(utcOffset.substr(1,2));var mins=parseInt(utcOffset.substr(3,4));var numSecs=(3600*hours)+(60*mins);if(sign==="+"){numSecs=-numSecs;}
this.addSeconds(numSecs);};var getOS=function(){var os="other";if(navigator.appVersion.indexOf("Win")!=-1){os="win"}
if(navigator.appVersion.indexOf("Mac")!=-1){os="mac";}
if(navigator.appVersion.indexOf("X11")!=-1){os="linux";}
if(navigator.appVersion.indexOf("Linux")!=-1){os="linux";}
return os;};var LayerManager=Class.create(UIElement,{initialize:function(controller){this.controller=controller;this.layers=$A([]);},hasId:function(id){},addLayer:function(layer){this.layers.push(layer);},numTileLayers:function(){var n=0;this.layers.each(function(l){if(l.type=="TileLayer"){n++;}});return n;},numEventLayers:function(){var n=0;this.layers.each(function(l){if(l.type=="EventLayer"){n++;}});return n;},removeLayer:function(layer){layer.domNode.remove();this.layers=this.layers.without(layer);},reloadLayers:function(){this.layers.each(function(layer){layer.reload();});},resetLayers:function(visible){this.layers.each(function(layer){layer.reset(visible);});}});var MessageConsole=Class.create(UIElement,{initialize:function(controller,container,viewport){this.controller=controller;this.console=$(container);this.viewportId=viewport;this.observe(this.controller.viewports[0],'info',this.log);},log:function(msg){this.console.update(new Element('p',{style:'color: #6495ED; font-weight: bold;'}).insert(msg));var trash=new Effect.Appear(this.console,{duration:3.0});var self=this;window.setTimeout(function(){var trash=new Effect.Fade(self.console,{duration:3.0});},6500);},info:function(msg){},warn:function(msg){this.console.update(new Element('p',{style:'color: yellow; font-weight: bolder;'}).insert(msg));var trash=new Effect.Appear(this.console,{duration:3.0});var self=this;window.setTimeout(function(){var trash=new Effect.Fade(self.console,{duration:3.0});},6500);},error:function(msg){this.console.update(new Element('p',{style:'color: red'}).insert(msg));var trash=new Effect.Shake(this.viewportId,{distance:15,duration:0.1});trash=new Effect.Appear(this.console,{duration:3.0});var self=this;window.setTimeout(function(){var trash=new Effect.Fade(self.console,{duration:3.0});},6500);},link:function(msg,linkText){var linkId='link-'+this.controller.date.getTime()/1000;var wrapper=new Element('span');var link=new Element('a',{href:'#',id:linkId,'class':'message-console-link'}).update(linkText);wrapper.insert(msg);wrapper.insert(link)
this.console.update(new Element('p',{style:'color: #6495ED;'}).insert(wrapper));var trash=new Effect.Appear(this.console,{duration:2.0});var self=this;Event.observe(linkId,'click',function(){self.console.hide();});return linkId;},observe:function(uielement,eventName,eventHandler){uielement.addObserver(eventName,eventHandler.bind(this));}});var MovieBuilder=Class.create(UIElement,{defaultOptions:{active:false,url:"api/getImageSeries.php",minZoomLevel:13,numFrames:40,frameRate:8,sharpen:false,edgeEnhance:false,format:{win:"asf",mac:"mov",linux:"mp4"}},initialize:function(options){Object.extend(this,this.defaultOptions);Object.extend(this,options);var self=this;Event.observe(this.id,'click',function(){if(!self.active){var hv=self.controller;self.active=true;var hqFormat=self.format[getOS()];var displayRange=hv.viewports[0].displayRange();var xhr=new Ajax.Request(self.url,{parameters:{action:"quickMovie",layers:"EITEIT304,LAS0C20WL",startDate:hv.date.getTime()/1000,zoomLevel:Math.max(hv.viewports[0].zoomLevel,self.minZoomLevel),numFrames:self.numFrames,frameRate:self.frameRate,edges:self.edgeEnhance,sharpen:self.sharpen,format:hqFormat,xRange:displayRange.xStart+", "+displayRange.xEnd,yRange:displayRange.yStart+", "+displayRange.yEnd},method:'get',onComplete:function(transport){var linkId=self.controller.messageConsole.link('','Quick-Video ready! Click here to start watching.');self.active=false;Event.observe(linkId,'click',function(){Shadowbox.open({player:'iframe',title:'Helioviewer Movie Player',height:650,width:550,content:self.url+'?action=play&format='+hqFormat+'&url='+transport.responseJSON});});}});}});},query:function(type){var url='get'+type+'.php';var self=this;var xhr=new Ajax.Request(url,{parameters:{type:'json'},method:'get',onComplete:function(transport){self.data.set(type,transport.responseJSON);}});}});var TileLayer=Class.create(Layer,{defaultOptions:{type:'TileLayer',tileSize:512,source:'database',rootDir:'tiles/',opacity:100,startOpened:false},initialize:function(viewport,options){Object.extend(this,this.defaultOptions);Object.extend(this,options);this.viewport=viewport;this.layerManager=viewport.controller.layerManager;this.id='tilelayer'+new Date().getTime();this.domNode=new Element('div',{className:'tile-layer-container',style:'position: absolute;'});viewport.movingContainer.appendChild(this.domNode);this.viewport.addObserver('move',this.viewportMove.bind(this));this.tiles=[];this.loadClosestImage();},reload:function(){this.loadClosestImage();},removeTiles:function(){this.tiles=[];},reset:function(visible){var i,j;if((this.viewport.zoomLevel<this.minZoom)&&(!this.warned)){this.viewport.controller.messageConsole.log("Warning: "+this.name+" is not available at this zoom level. Try a lower zoom-level.");this.warned=true;}
this.removeTiles();this.refreshUTCDate();var old=[];this.domNode.childElements().each(function(tile){old.push(tile);});var numTiles=0;var numTilesLoaded=0;var indices=this.viewport.visibleRange;for(i=indices.xStart;i<=indices.xEnd;i++){for(j=indices.yStart;j<=indices.yEnd;j++){if(visible[i][j]){var tile=$(this.domNode.appendChild(this.getTile(i,j,this.viewport.zoomLevel)));if(!this.tiles[i]){this.tiles[i]=[];}
this.tiles[i][j]={};this.tiles[i][j].img=tile;numTiles++;Event.observe(this.tiles[i][j].img,'load',function(e){numTilesLoaded++;if(numTilesLoaded==numTiles){old.each(function(tile){tile.parentNode&&tile.remove();});}});}}}},refreshUTCDate:function(){var date=new Date(this.timestamp*1000);date.toUTCDate();this.utcDate=date;},setImageProperties:function(imageProperties){if(imageProperties.imageId===this.imageId){this.fire('obs_time_change',this);return;}
Object.extend(this,imageProperties);this.fire('obs_time_change',this);this.setZIndex(parseInt(this.opacityGroupId));this.setInitialOpacity();this.fire('change',this);this.viewport.checkTiles(true);this.reset(this.viewport.visible);},setImage:function(imageId){if(imageId===this.imageId){return;}
this.imageId=imageId;this.loadImageProperties();this.reset(this.viewport.visible);},setInitialOpacity:function(){var self=this;var opacity=1;var counter=0;this.layerManager.layers.each(function(layer){if(parseInt(layer.opacityGroupId)==parseInt(self.opacityGroupId)){counter++;if(counter>1){opacity=opacity/counter;layer.domNode.setOpacity(opacity);layer.opacity=opacity*100;layer.domNode.setStyle({'filter':'alpha(opacity='+(opacity*100)+')',width:self.tileSize})}}});},setOpacity:function(opacity){this.opacity=opacity;opacity=opacity/100;this.domNode.setOpacity(opacity);this.domNode.setStyle({'filter':'alpha(opacity='+(opacity*100)+')'})},loadClosestImage:function(){var date=this.viewport.controller.date;var urlPrefix=this.viewport.controller.imageUrlPrefix;var url=urlPrefix+'?action=getClosest&observatory='+this.observatory+'&instrument='+this.instrument+'&detector='+this.detector+'&measurement='+this.measurement+'&timestamp='+(date.getTime()/1000);var processResponse=function(transport){this.setImageProperties(transport.responseJSON);var hv=this.viewport.controller;if(!hv.tileLayerAccordion.hasId(this.id)){hv.tileLayerAccordion.addLayer(this);}
else{hv.tileLayerAccordion.updateTimeStamp(this);hv.tileLayerAccordion.updateLayerDesc(this.id,this.name);}};var xhr=new Ajax.Request(url,{method:'get',onSuccess:processResponse.bind(this)});},viewportMove:function(position){var visible=this.viewport.visible;var indices=this.viewport.visibleRange;for(var i=indices.xStart;i<=indices.xEnd;i++){for(var j=indices.yStart;j<=indices.yEnd;j++){if(!this.tiles[i]){this.tiles[i]=[];}
if(visible[i][j]&&(!this.tiles[i][j])){this.tiles[i][j]=$(this.domNode.appendChild(this.getTile(i,j,this.viewport.zoomLevel)));}}}},getFullSize:function(){return Math.max(this.tileSize*2,Math.pow(2,this.maxZoomLevel-this.viewport.zoomLevel));},getTile:function(x,y){var left=x*this.tileSize;var top=y*this.tileSize;var img=$(new Image());img.toggleClassName('tile');img.setStyle({left:left+'px',top:top+'px'});img.unselectable='on';var rf=function(){return false;};img.onmousedown=rf;img.ondrag=rf;img.onmouseover=rf;img.oncontextmenu=rf;img.galleryimg='no';Event.observe(img,'error',function(){this.src='images/transparent.gif';})
img.src=this.getTileUrl(x,y,this.detector,this.viewport.zoomLevel,this.imageId);return img;},getTileUrl:function(x,y,detector,zoom,imageId){if(this.source==="database"){if(imageId===undefined){imageId='';}
return this.tileUrlPrefix+'?x='+x+'&y='+y+'&zoom='+zoom+'&imageId='+imageId;}
else if(this.source==="filesystem"){var filepath=this.getFilePath(x,y);return filepath;}},getFilePath:function(x,y){var offset=this.getTileOffset();var year=this.utcDate.getFullYear();var month=(this.utcDate.getMonth()+1).toString().padLeft('0',2);var day=this.utcDate.getDate().toString().padLeft('0',2);var hour=this.utcDate.getHours().toString().padLeft('0',2);var min=this.utcDate.getMinutes().toString().padLeft('0',2);var sec=this.utcDate.getSeconds().toString().padLeft('0',2);var obs=this.observatory.toLowerCase();var inst=this.instrument;var det=this.detector;var meas=this.measurement;var zoom=this.viewport.zoomLevel;var xStr="+"+x.toString().padLeft('0',2);if(x.toString().substring(0,1)=="-"){xStr="-"+x.toString().substring(1).padLeft('0',2);}
var yStr="+"+y.toString().padLeft('0',2);if(y.toString().substring(0,1)=="-"){yStr="-"+y.toString().substring(1).padLeft('0',2);}
var path=this.rootDir+year+"/"+month+"/"+day+"/"+hour+"/"+obs+"/"+inst+"/"+det+"/"+meas+"/";var file=year+"_"+month+"_"+day+"_"+hour+min+sec+"_"+obs+"_"+inst+"_"+det+"_"+meas+"_"+zoom+"_"+xStr+"_"+yStr+"."+this.filetype;return(path+file);},getTileOffset:function(){return 0;},getNumTiles:function(){var zoom=this.viewport.zoomLevel;var diff=parseInt(this.lowestRegularZoom)-zoom;return Math.max(4,Math.pow(4,1+diff));}});var TileLayerAccordion=Class.create(Layer,{initialize:function(layerManager,containerId){this.layerManager=layerManager;this.container=jQuery('#'+containerId);this.queryURL="getLayerAvailability.php";this.options={};this._setupUI();this.domNode=jQuery('#TileLayerAccordion-Container');this.domNode.dynaccordion({startClosed:true});this.layerSettings=new Hash();},addLayer:function(layer){var processResponse=function(transport){var visibilityBtn="<button class='layerManagerBtn visible' id='visibilityBtn-"+layer.id+"' value=true type=button title='toggle layer visibility'></button>";var removeBtn="<button class='layerManagerBtn remove' id='removeBtn-"+layer.id+"' type=button title='remove layer'></button>";var head="<div class=layer-Head><span class=tile-accordion-header-left>"+layer.name+"</span><span class=tile-accordion-header-right><span class=timestamp></span> |"+visibilityBtn+removeBtn+"</span></div>";this.options.observatories=transport.responseJSON.observatories;this.options.instruments=transport.responseJSON.instruments;this.options.detectors=transport.responseJSON.detectors;this.options.measurements=transport.responseJSON.measurements;var body=this._buildEntryBody(layer);this.domNode.dynaccordion("addSection",{id:layer.id,header:head,cell:body,open:layer.startOpened});new Control.Slider("opacity-slider-handle-"+layer.id,"opacity-slider-track-"+layer.id,{sliderValue:layer.opacity,range:$R(1,100),values:$R(1,100),onSlide:function(v){layer.setOpacity(v);}});this.layerSettings.set(layer.id,{header:head,body:body});this._setupEventHandlers(layer);this.updateTimeStamp(layer);};var xhr=new Ajax.Request(this.queryURL,{method:'get',onSuccess:processResponse.bind(this),parameters:{observatory:layer.observatory,instrument:layer.instrument,detector:layer.detector,measurement:layer.measurement,format:"json"}});},hasId:function(id){return(this.layerSettings.keys().grep(id).length>0?true:false);},_buildEntryBody:function(layer){var id=layer.id;var options=this.options;var opacitySlide="<div class='layer-select-label'>Opacity: </div>";opacitySlide+="<div class='opacity-slider-track' id='opacity-slider-track-"+id+"' style='width:120px; height:10px;'>";opacitySlide+="<div class='opacity-slider-handle' id='opacity-slider-handle-"+id+"' style='10px; 19px;'></div>"
opacitySlide+="</div>";var obs="<div class=layer-select-label>Observatory: </div> ";obs+="<select name=observatory class=layer-select id='observatory-select-"+id+"'>";jQuery.each(options.observatories,function(i,o){obs+="<option value='"+o.abbreviation+"'";if(layer.observatory==o.abbreviation){obs+=" selected='selected'";}
obs+=">"+o.name+"</option>";});obs+="</select><br>";var inst="<div class=layer-select-label>Instrument: </div> ";inst+="<select name=instrument class=layer-select id='instrument-select-"+id+"'>";jQuery.each(options.instruments,function(i,o){inst+="<option value='"+o.abbreviation+"'";if(layer.instrument==o.abbreviation){inst+=" selected='selected'";}
inst+=">"+o.name+"</option>";});inst+="</select><br>";var det="<div class=layer-select-label>Detector: </div> ";det+="<select name=detector class=layer-select id='detector-select-"+id+"'>";jQuery.each(options.detectors,function(i,o){det+="<option value='"+o.abbreviation+"'";if(layer.detector==o.abbreviation){det+=" selected='selected'";}
det+=">"+(o.name===""?o.abbreviation:o.name)+"</option>";});det+="</select><br>";var meas="<div class=layer-select-label>Measurement: </div> ";meas+="<select name=measurement class=layer-select id='measurement-select-"+id+"'>";jQuery.each(options.measurements,function(i,o){meas+="<option value='"+o.abbreviation+"'";if(layer.measurement==o.abbreviation){meas+=" selected='selected'";}
meas+=">"+o.name+"</option>";});meas+="</select><br>";return(opacitySlide+obs+inst+det+meas);},_addOpacitySlider:function(layer){},_setupUI:function(){var title=jQuery('<span>Layers</span>').css({'float':'left','color':'black','font-weight':'bold'});var addLayerBtn=jQuery('<a href=# class=gray>[Add Layer]</a>').css({'margin-right':'14px'});this.container.append(jQuery('<div></div>').css('text-align','right').append(title).append(addLayerBtn));var innerContainer=jQuery('<ul id=TileLayerAccordion></ul>');var outerContainer=jQuery('<div id="TileLayerAccordion-Container"></div>').append(innerContainer);this.container.append(outerContainer);var self=this;var hv=this.layerManager.controller;addLayerBtn.click(function(){self.layerManager.addLayer(new TileLayer(hv.viewports[0],{tileUrlPrefix:hv.tileUrlPrefix,observatory:'soho',instrument:'LAS',detector:'0C2',measurement:'0WL',startOpened:true}));});},_setupEventHandlers:function(layer){visibilityBtn=jQuery("#visibilityBtn-"+layer.id);removeBtn=jQuery("#removeBtn-"+layer.id);var toggleVisibility=function(e){var visible=layer.toggleVisible();var icon=(visible?'LayerManagerButton_Visibility_Visible.png':'LayerManagerButton_Visibility_Hidden.png');jQuery("#visibilityBtn-"+layer.id).css('background','url(images/blackGlass/'+icon+')');e.stopPropagation();};var removeLayer=function(e){var accordion=e.data;accordion.layerManager.removeLayer(layer);accordion.domNode.dynaccordion('removeSection',{id:layer.id});accordion.layerSettings.unset(layer.id);e.stopPropagation();};var self=this;jQuery.each(jQuery('#'+layer.id+' > div > select'),function(i,item){jQuery(item).change(function(e){if(this.name==="observatory"){layer.observatory=this.value;}
else if(this.name==="instrument"){layer.instrument=this.value;}
else if(this.name==="detector"){layer.detector=this.value;}
else if(this.name==="measurement"){layer.measurement=this.value;}
self._onLayerSelectChange(layer,this.name,this.value);})});visibilityBtn.bind('click',this,toggleVisibility);removeBtn.bind('click',this,removeLayer);},_onLayerSelectChange:function(layer,changed,value){var processResponse=function(transport){this.options=transport.responseJSON;if(changed==="observatory"){this._updateOptions(layer.id,"instrument",this.options.instruments);if($A(this.options.instruments).grep(layer.instrument).length==0){layer.instrument=this.options.instruments[0];}}
if((changed==="observatory")||(changed==="instrument")){this._updateOptions(layer.id,"detector",this.options.detectors);if(!$A(this.options.detectors).find(function(det){return det.abbreviation==layer.detector;})){layer.detector=this.options.detectors[0].abbreviation;}}
if((changed==="observatory")||(changed==="instrument")||(changed==="detector")){this._updateOptions(layer.id,"measurement",this.options.measurements);if(!$A(this.options.measurements).find(function(meas){return meas.abbreviation==layer.measurement;})){layer.measurement=this.options.measurements[0].abbreviation;}}
layer.reload();};if(changed!=="measurement"){var obs=(changed==="observatory"?value:layer.observatory);var inst=(changed==="instrument"?value:layer.instrument);var det=(changed==="detector"?value:layer.detector);var meas=(changed==="measurement"?value:layer.measurement);var xhr=new Ajax.Request(this.queryURL,{method:'get',onSuccess:processResponse.bind(this),parameters:{observatory:obs,instrument:inst,detector:det,measurement:meas,format:"json",changed:changed,value:value}});}
else{layer.reload();}},_updateOptions:function(id,field,newOptions){$$('#'+field+'-select-'+id+' > option').each(function(o){o.remove();});var select=$(field+'-select-'+id);$A(newOptions).each(function(o){var opt=new Element('option',{value:o.abbreviation}).insert(o.name===""?o.abbreviation:o.name);select.insert(opt);});},updateTimeStamp:function(layer){var domNode=$(layer.id).select('.timestamp').first();domNode.removeClassName("timeBehind");domNode.removeClassName("timeAhead");domNode.removeClassName("timeSignificantlyOff");var date=new Date(layer.timestamp*1000);var dateString=date.toYmdUTCString()+' '+date.toHmUTCString();var timeDiff=layer.timestamp-this.layerManager.controller.date.getTime()/1000;domNode.update(dateString);var ts=this.layerManager.controller.timeStepSlider.timestep.numSecs;if(timeDiff<0){if(Math.abs(timeDiff)>(4*ts)){domNode.addClassName("timeSignificantlyOff");}
else{domNode.addClassName("timeBehind");}}
else if(timeDiff>0){if(timeDiff>(4*ts)){domNode.addClassName("timeSignificantlyOff");}
else{domNode.addClassName("timeAhead");}}},updateLayerDesc:function(id,desc){$(id).select("span.tile-accordion-header-left").first().update(desc);}});var TimeStepSlider=Class.create(UIElement,{initialize:function(controller,sliderHandleId,sliderTrackId,backBtn,forwardBtn,timeIncrement,initialIndex){this.controller=controller;this.slider=new Control.Slider(sliderHandleId,sliderTrackId,{axis:'horizontal',range:$R(1,10),values:[1,2,3,4,5,6,7,8,9,10],sliderValue:initialIndex,onChange:this.onChange.bindAsEventListener(this),onSlide:this.onSlide.bindAsEventListener(this)});this.className="TimeStepSlider";this.lastIndex=initialIndex;this.timestep=this.indexToTimeStep(initialIndex);this.timeIncrement=timeIncrement;Event.observe(backBtn,'click',this.timePrevious.bind(this));Event.observe(forwardBtn,'click',this.timeNext.bind(this));},indexToTimeStep:function(index){var timeSteps=[{numSecs:1,txt:"1&nbsp;Sec"},{numSecs:1,txt:"1&nbsp;Sec"},{numSecs:60,txt:"1&nbsp;Min"},{numSecs:300,txt:"5&nbsp;Mins"},{numSecs:900,txt:"15&nbsp;Mins"},{numSecs:3600,txt:"1&nbsp;Hour"},{numSecs:21600,txt:"6&nbsp;Hours"},{numSecs:43200,txt:"12&nbsp;Hours"},{numSecs:86400,txt:"1&nbsp;Day"},{numSecs:604800,txt:"1&nbsp;Week"},{numSecs:2419200,txt:"28&nbsp;Days"}];return timeSteps[index];},onChange:function(index){if(index!==null){this.timestep=this.indexToTimeStep(index);this.fire('timeIncrementChange',this.timestep.numSecs);}},onSlide:function(index){if((index!==null)&&(index!==this.lastIndex)){this.lastIndex=index;$('timestepValueDisplay').update(this.indexToTimeStep(index).txt);}},setTimeIncrement:function(timeIncrement){this.timeIncrement=timeIncrement;},timePrevious:function(){var newDate=this.controller.date.addSeconds(-this.timeIncrement);this.controller.setDate(newDate);this.controller.calendar.updateFields();},timeNext:function(){var newDate=this.controller.date.addSeconds(this.timeIncrement);this.controller.setDate(newDate);this.controller.calendar.updateFields();}});var Viewport=Class.create(UIElement,{defaultOptions:{zoomLevel:0,headerId:'middle-col-header',footerId:'footer',tileSize:512,debug:false,prefetch:0},isMoving:false,dimensions:{width:0,height:0},initialize:function(controller,options){Object.extend(this,this.defaultOptions);Object.extend(this,options);this.domNode=$(this.id);this.innerNode=$(this.id+'-container-inner');this.outerNode=$(this.id+'-container-outer');this.controller=controller;this.ViewportHandlers=new ViewportHandlers(this);this.headerAndFooterHeight=$(this.headerId).getDimensions().height+$(this.footerId).getDimensions().height+4;this.resize();var center=this.getCenter();this.movingContainer=$(this.domNode.appendChild(Builder.node('div',{className:'movingContainer'})));this.movingContainer.setStyle({'left':center.x+'px','top':center.y+'px'});if(this.debug){this.movingContainer.setStyle({'border':'1px solid red'});var centerBox=new Element('div',{style:'position: absolute; width: 50px; height: 50px; border: 1px dashed red; '});centerBox.setStyle({'left':(center.x-25)+'px','top':(center.y-25)+'px'});this.domNode.insert(centerBox);}},center:function(){var center=this.getCenter();this.moveTo(center.x,center.y);},moveTo:function(x,y){this.movingContainer.setStyle({left:x+'px',top:y+'px'});this.checkTiles();this.fire('move',{x:x,y:y});},moveBy:function(x,y){var pos={x:this.startMovingPosition.x-x,y:this.startMovingPosition.y-y};this.movingContainer.setStyle({left:pos.x+'px',top:pos.y+'px'});this.checkTiles();this.fire('move',{x:pos.x,y:pos.y});},startMoving:function(){this.startMovingPosition=this.getContainerPos();},getCenter:function(){return{x:Math.round(this.domNode.getWidth()/2),y:Math.round(this.domNode.getHeight()/2)}},getContainerPos:function(){return{x:parseInt(this.movingContainer.getStyle('left')),y:parseInt(this.movingContainer.getStyle('top'))}},currentPosition:function(){return this.getContainerPos();},helioCenter:function(){return this.getContainerPos();},endMoving:function(){},checkTiles:function(){this.visible=[];var indices=this.displayRange();for(i=indices.xStart;i<=indices.xEnd;i++){for(j=indices.yStart;j<=indices.yEnd;j++){if(!this.visible[i]){this.visible[i]=[];}
this.visible[i][j]=true;}}},displayRange:function(){var vp=this.getHCViewportPixelCoords();var ts=this.tileSize;vp={top:vp.top-ts-(vp.top%ts),left:vp.left-ts-(vp.left%ts),bottom:vp.bottom+ts-(vp.bottom%ts),right:vp.right+ts-(vp.right%ts)}
this.visibleRange={xStart:vp.left/ts,xEnd:vp.right/ts,yStart:vp.top/ts,yEnd:vp.bottom/ts}
return this.visibleRange;},getViewportPixelCoords:function(){var dimensions=this.domNode.getDimensions();return{top:-this.prefetch,left:-this.prefetch,bottom:dimensions.height+this.prefetch,right:dimensions.width+this.prefetch}},getHCViewportPixelCoords:function(){var vp=this.getViewportPixelCoords();var hc=this.helioCenter();vp.top-=hc.y;vp.left-=hc.x;vp.bottom-=hc.y;vp.right-=hc.x;return vp;},zoomTo:function(zoomLevel){this.zoomLevel=zoomLevel;this.checkTiles();this.controller.layerManager.resetLayers(this.visible);},resize:function(){var oldDimensions=this.dimensions;var viewportOuter=this.outerNode;viewportOuter.setStyle({height:document.viewport.getHeight()-this.headerAndFooterHeight+'px'});this.dimensions=this.domNode.getDimensions();this.dimensions.width+=this.prefetch;this.dimensions.height+=this.prefetch;if(this.dimensions.width!==oldDimensions.width||this.dimensions.height!==oldDimensions.height){if(this.controller.layerManager.layers.length>0){this.checkTiles();this.controller.layerManager.resetLayers(this.visible);}}}});var ViewportHandlers=Class.create({startingPosition:{x:0,y:0},mouseStartingPosition:{x:0,y:0},mouseCurrentPosition:{x:0,y:0},moveCounter:0,moveThrottle:2,initialize:function(viewport){this.viewport=viewport;this.bMouseMove=this.mouseMove.bindAsEventListener(this);this.bMouseDown=this.mouseDown.bindAsEventListener(this);this.bMouseUp=this.mouseUp.bindAsEventListener(this);Event.observe(window,'mousemove',this.bMouseMove);Event.observe(document,'mousemove',this.bMouseMove);Event.observe(this.viewport.domNode,'mousedown',this.bMouseDown);Event.observe(window,'mouseup',this.bMouseUp);Event.observe(document,'mouseup',this.bMouseUp);Event.observe(this.viewport.domNode,'dblclick',this.doubleClick.bindAsEventListener(this));Event.observe(document,'keypress',this.keyPress.bindAsEventListener(this));Event.observe(window,'keypress',this.keyPress.bindAsEventListener(this));},mouseDown:function(event){this.viewport.isMoving=true;this.startingPosition=this.viewport.currentPosition();this.mouseStartingPosition={x:Event.pointerX(event),y:Event.pointerY(event)};this.viewport.domNode.setStyle({cursor:'all-scroll'});if(this.viewport.domNode.setCapture){this.viewport.domNode.setCapture();}
this.viewport.startMoving();},doubleClick:function(e){var viewport=this.viewport;if((e.shiftKey||(viewport.zoomLevel>viewport.controller.minZoomLevel))&&(viewport.zoomLevel<viewport.controller.maxZoomLevel)){if(e.isLeftClick()){var xOffset=$('left-col').getDimensions().width+Math.round(0.03*viewport.outerNode.getDimensions().width)+2;var yOffset=$(viewport.headerId).getDimensions().height+Math.round(0.03*viewport.outerNode.getDimensions().height)+3;var mouseCoords={x:e.pointerX()-xOffset,y:e.pointerY()-yOffset}
var containerPos=viewport.getContainerPos();var x=mouseCoords.x-containerPos.x;var y=mouseCoords.y-containerPos.y;viewport.center();this.viewport.startMoving();if(e.shiftKey){viewport.moveBy(0.5*x,0.5*y);viewport.controller.zoomControl.zoomButtonClicked(1);}
else{viewport.moveBy(2*x,2*y);viewport.controller.zoomControl.zoomButtonClicked(-1);}}}else{Debug.output("Out of bounds double-click request! See Viewport.js:57");}},keyPress:function(e){var key=e.keyCode;if(e.target.tagName!=="INPUT"){if(key==37||key==38||key==39||key==40){this.startingPosition=this.viewport.currentPosition();this.viewport.startMoving();this.moveCounter=(this.moveCounter+1)%this.moveThrottle;if(this.moveCounter!==0){return;}
if(key==37){this.viewport.moveBy(8,0);}
else if(e.keyCode==38){this.viewport.moveBy(0,8);}
else if(e.keyCode==39){this.viewport.moveBy(-8,0);}
else if(e.keyCode==40){this.viewport.moveBy(0,-8);}}}},mouseUp:function(event){this.viewport.isMoving=false;this.viewport.domNode.setStyle({cursor:'pointer'});if(this.viewport.domNode.releaseCapture){this.viewport.domNode.releaseCapture();}
this.viewport.endMoving();},keyRelease:function(event){this.viewport.isMoving=false;this.viewport.endMoving();},mouseMove:function(event){if(!this.viewport.isMoving){return;}
this.moveCounter=(this.moveCounter+1)%this.moveThrottle;if(this.moveCounter!==0){return;}
this.mouseCurrentPosition={x:Event.pointerX(event),y:Event.pointerY(event)};this.viewport.moveBy(this.mouseStartingPosition.x-this.mouseCurrentPosition.x,this.mouseStartingPosition.y-this.mouseCurrentPosition.y);}});var ZoomControl=Class.create(UIElement,{initialize:function(controller,options){Object.extend(this,options);this.controller=controller;this.domNode=$(this.id);this.handle=$(this.id+'Handle');var range=$R(this.minZoomLevel,this.maxZoomLevel);this.slider=new Control.Slider(this.handle,this.id+'Track',{axis:'vertical',values:range,sliderValue:this.zoomLevel,range:range,onChange:this.changed.bind(this)});Event.observe($(this.id+'ZoomIn'),'click',this.zoomButtonClicked.bind(this,-1));Event.observe($(this.id+'ZoomIn'),'mousedown',function(e){Event.stop(e);});Event.observe($(this.id+'ZoomOut'),'mouseup',this.zoomButtonClicked.bind(this,1));Event.observe($(this.id+'ZoomOut'),'mousedown',function(e){Event.stop(e);});},zoomButtonClicked:function(dir){this.slider.setValue(this.slider.value+dir);},changed:function(v){this.fire('change',v);}});__INSTRUMENTS__={'EIT':{'dataAvailability':{'startDate':new Date(Date.UTC(2003,9,5)),'endDate':new Date(Date.UTC(2003,9,6)),'minZoom':12,'maxZoom':20},'measurements':{'type':'wavelength'}}};