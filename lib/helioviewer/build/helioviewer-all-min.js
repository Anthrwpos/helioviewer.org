
var LoadingIndicator=Class.create();LoadingIndicator.prototype={initialize:function(){this.loadingItems=[];Ajax.Responders.register({onCreate:this.loadingStarted.bind(this,'Ajax'),onComplete:this.loadingFinished.bind(this,'Ajax')});},show:function(){$('loading').show();},hide:function(){$('loading').hide();},reset:function(){this.loadingItems.length=0;this.hide();},loadingStarted:function(item){this.show();this.loadingItems.push({});},loadingFinished:function(item){this.loadingItems.pop();if(this.loadingItems.length===0){this.hide();}}};var UIElement=Class.create({addObserver:function(eventName,callback){if(!this.observers){this.observers=[];}
if(!this.observers[eventName]){this.observers[eventName]=$A([]);}
this.observers[eventName].push(callback);return this;},fire:function(eventName,eventParameters){if(!this.observers||!this.observers[eventName]||this.observers[eventName].length===0){return this;}
this.observers[eventName].each(function(callback){callback(eventParameters);});return this;}});var Layer=Class.create(UIElement,{maxZoomLevel:20,minZoomLevel:10,visible:true,initialize:function(viewport){this.viewport=viewport;this.domNode=$(viewport.movingContainer.appendChild(new Element('div')));this.viewport.addObserver('move',this.viewportMove.bind(this));this.id='layer'+Math.floor(Math.random()*100000+1);},setZIndex:function(v){this.domNode.setStyle({zIndex:v});},setVisible:function(visible){this.visible=visible;this.domNode.setStyle({visibility:(visible?'visible':'hidden')});return this.visible;},toggleVisible:function(){return this.setVisible(!this.visible);}});var AjaxRequestWrapper=Class.create();AjaxRequestWrapper.cache={};AjaxRequestWrapper.getCached=Class.create();AjaxRequestWrapper.getCached.prototype={initialize:function(url,callback){this.url=url;this.callback=callback;this.args=$A(arguments).slice(2);var self=this;if(AjaxRequestWrapper.cache[url]){callback.apply(null,$A([AjaxRequestWrapper.cache[self.url]]).concat(self.args));}else{var onSuccess=function(transport){AjaxRequestWrapper.cache[self.url]=transport.responseText;callback.apply(null,$A([AjaxRequestWrapper.cache[self.url]]).concat(self.args));};var onFailure=function(transport){Debug.ajaxFailure(transport,self.url);};var trash=new Ajax.Request(url,{method:'get',onSuccess:onSuccess,onFailure:onFailure});}}};var Calendar=Class.create(UIElement,{initialize:function(controller,dateFieldId,timeFieldId){this.controller=controller;this.dateField=$(dateFieldId);this.timeField=$(timeFieldId);var self=this;this.cal=jQuery("#"+dateFieldId).datepicker({buttonImage:'images/blackGlass/glass_button_calendar.png',buttonImageOnly:true,dateFormat:'yy/mm/dd',mandatory:true,showOn:'both',yearRange:'1998:2008',onSelect:function(dateStr){window.setTimeout(function(){var time=self.timeField.value;var date=Date.parse(dateStr);var hours=parseInt(time.substring(0,2));var minutes=parseInt(time.substring(3,5));var seconds=parseInt(time.substring(6,8));var utcDate=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate(),hours,minutes,seconds));self.fire('observationDateChange',utcDate);},500);}});},updateFields:function(){this.dateField.value=this.controller.date.toYmdUTCString();this.timeField.value=this.controller.date.toHmUTCString();}});var Coordinates=Class.create({});Coordinates.getOffset=function(fullSize,tileSize){return 0;};Coordinates.worldAbs2rel=function(coords,fullSize,tileSize){var offset=Coordinates.getOffset(fullSize,tileSize);return{x:(coords.x-offset)/fullSize,y:(coords.y-offset)/fullSize};};Coordinates.worldRel2abs=function(coords,fullSize,tileSize){var offset=Coordinates.getOffset(fullSize,tileSize);return{x:Math.round(coords.x*fullSize)+offset,y:Math.round(coords.y*fullSize)+offset};};var DataNavigator=Class.create(UIElement,{initialize:function(controller){this.controller=controller;this.data=new Hash();},query:function(type){var url='get'+type+'.php';var self=this;var xhr=new Ajax.Request(url,{parameters:{type:'json'},method:'get',onComplete:function(transport){self.data.set(type,transport.responseJSON);}});}});var Debug=Class.create();Debug.outputBuffer='';Debug.outputTimeout=null;Debug.loadingItemCount=0;Debug.loadingIndicator=new LoadingIndicator();Debug.test=function(xIndex,yIndex,level){xIndex=9;level=3;for(var l=0;l<=level;l++){var x=(xIndex>>(level-l+1))/(1<<l);var x2=1/(1<<l+1);Debug.output(x,(1<<l),(xIndex>>(level-l)),x2);}};Debug.output=function(){var txt='';for(var i=0;i<arguments.length;i++){txt+=arguments[i];if(i<arguments.length-1){txt+=', ';}}
if(window.console){window.console.log(txt);}else{if(Debug.outputTimeout){clearTimeout(Debug.outputTimeout);}
Debug.outputBuffer=txt+'\n'+Debug.outputBuffer;Debug.outputTimeout=setTimeout(Debug.flush,100);}};Debug.plotArray=function(a){Debug.output('----\n'+Debug.strArray(a,'',0));};Debug.strArray=function(a,indent,index){if(a instanceof Array){if(a.length===0){return indent+index+': []\n';}
var txt=indent+index+': [\n';var c=0;a.each(function(m){txt+=Debug.strArray(m,indent+'  ',c);++c;});return txt+indent+']\n';}else{return indent+index+': '+a+'\n';}};Debug.flush=function(){if($('debugOutput')){$('debugOutput').innerHTML='----\n'+Debug.outputBuffer+$('debugOutput').innerHTML;Debug.outputBuffer='';}};Debug.ajaxFailure=function(transport,url){Debug.output('Error getting file "'+url+'": '+transport.status+' '+transport.statusText);};var DomNodeCache=Class.create();DomNodeCache.prototype={initialize:function(){this.cache=$A([]);},list:function()
{return this.cache;},add:function(element,zoomLevel,xIndex,yIndex){if(!this.cache[zoomLevel]){this.cache[zoomLevel]=[];}
if(!this.cache[zoomLevel][xIndex]){this.cache[zoomLevel][xIndex]=[];}
this.cache[zoomLevel][xIndex][yIndex]=element;},get:function(zoomLevel,xIndex,yIndex){if(this.cache[zoomLevel]&&this.cache[zoomLevel][xIndex]&&this.cache[zoomLevel][xIndex][yIndex]){return this.cache[zoomLevel][xIndex][yIndex];}
return null;},contains:function(zoomLevel,xIndex,yIndex){return(this.cache[zoomLevel]&&this.cache[zoomLevel][xIndex]&&this.cache[zoomLevel][xIndex][yIndex]?true:false);},zoomLevels:function(){return this.cache.length;},clear:function(){this.cache=$A([]);return this;},remove:function(){this.cache.flatten().each(function(element){if(element&&element.parentNode){element.remove();}});return this;},removeAndClear:function(){this.remove().clear();},setStyle:function(style){this.cache.flatten().each(function(domNode){if(domNode&&domNode.style){$(domNode).setStyle(style);}});}};var EventLayer=Class.create(Layer,{defaultOptions:{type:'EventLayer',sunRadius0:94*(1<<12),opacityGroupId:-1,displayLabels:false,windowSize:43200},initialize:function(viewport,options){Object.extend(this,this.defaultOptions);Object.extend(this,options);this.viewport=viewport;this.id='eventlayer'+Math.floor(Math.random()*100000+1);this.events=$A([]);this.domNode=new Element('div',{className:'event-layer'});this.viewport.movingContainer.appendChild(this.domNode);this.queryEvents();},queryEvents:function(){var processResponse=function(transport){this.clear();this.displayEvents(transport.responseJSON);if(!this.eventAccordion.hasId(this.id)){this.eventAccordion.addLayer(this);}};var xhr=new Ajax.Request('getEvents.php',{method:'get',onSuccess:processResponse.bind(this),parameters:{task:'getPoi',date:this.viewport.controller.date.toISOString().slice(1,-1),windowSize:this.windowSize,catalogs:this.catalog}});},viewportMove:function(){},clear:function(){this.events.each(function(e){e.remove();});this.events.clear();},displayEvents:function(jsonEvents){var self=this;var date=this.viewport.controller.date;var UTCOffset=-parseInt(date.getTimezoneOffset())*60;var sunRadius=this.sunRadius0>>this.viewport.zoomLevel;jsonEvents.each(function(event){self.events.push(new EventMarker(self,event,date,UTCOffset,sunRadius));});},toggleLabelVisibility:function(){this.displayLabels=!this.displayLabels;this.events.each(function(e){e.toggleLabel();});},reload:function(){this.queryEvents();},reset:function(){var sunRadius=this.sunRadius0>>this.viewport.zoomLevel;this.events.each(function(e){e.refresh(sunRadius);});}});var EventLayerAccordion=Class.create(Layer,{initialize:function(viewport,containerId){this.viewport=viewport;this.container=jQuery('#'+containerId);this._setupUI();this.domNode=jQuery('#EventLayerAccordion-Container');this.domNode.dynaccordion();this.getEventCatalogs();this.layers=$A([]);},addLayer:function(layer){var title=this.eventCatalogs.get(layer.catalog).name;var visibilityBtn="<button class='layerManagerBtn visible' id='visibilityBtn-"+layer.id+"' value=true type=button title='toggle layer visibility'></button>";var removeBtn="<button class='layerManagerBtn remove' id='removeBtn-"+layer.id+"' type=button title='remove layer'></button>";var head="<div class=layer-Head><span class=event-accordion-header-left>"+title+"</span><span class=event-accordion-header-right>"+visibilityBtn+removeBtn+"</span></div>";var body='<div style="color: white;">CME and AR event data from VSO and CACTus.</div>';this.domNode.dynaccordion("addSection",{id:layer.id,header:head,cell:body});this._setupEventHandlers(layer);this.layers.push(layer.id);},getEventCatalogs:function(){var self=this;var url="static_data/eventCatalogs.json";jQuery.getJSON(url,function(catalogs){self.eventCatalogs=new Hash();catalogs.each(function(catalog){self.eventCatalogs.set(catalog.id,catalog);});self.viewport.addLayer(new EventLayer(self.viewport,{catalog:"VSOService::cmelist",eventAccordion:self}));self.viewport.addLayer(new EventLayer(self.viewport,{catalog:"VSOService::type2cme",eventAccordion:self}));self.viewport.addLayer(new EventLayer(self.viewport,{catalog:"VSOService::noaa",eventAccordion:self,windowSize:86400}));self.viewport.addLayer(new EventLayer(self.viewport,{catalog:"CACTusService::CACTus",eventAccordion:self}));});},hasId:function(id){return(this.layers.grep(id).length>0?true:false);},_setupUI:function(){var title=jQuery('<span>Events</span>').css({'float':'left','color':'black','font-weight':'bold'});var addLayerBtn=jQuery('<a href=#>[Add Events]</a>').css({'margin-right':'14px','color':'#9A9A9A','text-decoration':'none','font-style':'italic','cursor':'default'});this.container.append(jQuery('<div></div>').css('text-align','right').append(title).append(addLayerBtn));var innerContainer=jQuery('<ul id=EventLayerAccordion></ul>');var outerContainer=jQuery('<div id="EventLayerAccordion-Container"></div>').append(innerContainer);this.container.append(outerContainer);},_setupEventHandlers:function(layer){visibilityBtn=jQuery("#visibilityBtn-"+layer.id);removeBtn=jQuery("#removeBtn-"+layer.id);var toggleVisibility=function(e){var visible=layer.toggleVisible();var icon=(visible?'LayerManagerButton_Visibility_Visible.png':'LayerManagerButton_Visibility_Hidden.png');jQuery("#visibilityBtn-"+layer.id).css('background','url(images/blackGlass/'+icon+')');e.stopPropagation();};var removeLayer=function(e){var self=e.data;self.viewport.controller.layerManager.remove(self,layer);self.domNode.dynaccordion('removeSection',{id:layer.id});self.layers=self.layers.without(layer.id);e.stopPropagation();};visibilityBtn.bind('click',this,toggleVisibility);removeBtn.bind('click',this,removeLayer);}});var EventMarker=Class.create({initialize:function(eventLayer,event,date,utcOffset,sunRadius,options){Object.extend(this,event);Object.extend(this,options);this.eventLayer=eventLayer;this.appDate=date;this.utcOffset=utcOffset;this.sunRadius=sunRadius;var catalogs=eventLayer.eventAccordion.eventCatalogs;this.catalogName=catalogs.get(this.catalogId).name;this.type=catalogs.get(this.catalogId).eventType;this.pos={x:this.sunX*sunRadius,y:this.sunY*sunRadius}
this.container=this.eventLayer.domNode.appendChild(new Element('div',{className:'event',style:'left: '+(this.pos.x-2)+'px; top: '+(this.pos.y-2)+'px;'}));this.createMarker();this.createLabel();this.createPopup();},createMarker:function(){var cssId=this.catalogId.gsub('::',"_");var marker=new Element('div',{className:cssId+' '+this.type.gsub(' ','_')+' event-marker'});var self=this;marker.observe('click',function(event){self.togglePopup();});this.marker=marker;this.container.appendChild(marker);},createLabel:function(){var display=(this.eventLayer.displayLabels?"inline":"none");var labelText=null;switch(this.type){case"Active Region":labelText=this.eventId;break;case"CME":labelText=this.startTime;break;case"Type II Radio Burst":labelText=this.startTime;break;default:labelText=this.startTime;break;}
var eventDate=Date.parse(this.startTime.substr(0,19)).addSeconds(this.utcOffset);var timeDiff=eventDate.getTime()-this.appDate.getTime();var label=new Element('div',{className:'event-label'}).setStyle({'display':display}).insert(labelText);if(timeDiff<0){label.addClassName("timeBehind");}
else if(timeDiff>0){label.addClassName("timeAhead");}
this.label=label;this.container.appendChild(label);},createPopup:function(){var popup=new Element('div',{className:'event-popup tooltip-topleft-large',style:'display: none;'});var content="<div class='event-popup-container'>"+"<strong>"+this.type+" "+this.eventId+"</strong><br>"+"<p>"+this.catalogName+"</p><br>"+"<strong>start:</strong> "+this.startTime+"<br>"+"<strong>end:</strong> "+this.endTime+"<br><br>"+"<strong>Position Angle:</strong> "+this.polarCpa+"&deg; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+"<strong>Width:</strong> "+this.polarWidth+"&deg;<br>"+"<strong>Source:</strong> <a href='"+this.sourceUrl+"' class='event-url'>"+this.sourceUrl+"</a><br>"+"</div>";popup.update(content);var closeBtn=new Element('a',{className:'event-popup-close-btn'}).insert("x");closeBtn.observe('click',this.togglePopup.bind(this));popup.insert(closeBtn);this.popup=popup;this.container.appendChild(popup);},remove:function(){this.container.remove();},refresh:function(sunRadius){this.sunRadius=sunRadius;this.pos={x:this.sunX*sunRadius,y:this.sunY*sunRadius};this.container.setStyle({left:(this.pos.x-2)+'px',top:(this.pos.y-2)+'px'});},toggleLabel:function(){this.label.toggle();},togglePopup:function(){this.popup.toggle();}});var Helioviewer=Class.create({defaultOptions:{defaultZoomLevel:12,defaultPrefetchSize:256,timeIncrementSecs:86400,minZoomLevel:9,maxZoomLevel:20,tileUrlPrefix:'getTile.php',imageUrlPrefix:'getImage.php',eventUrlPrefix:'getEvents.php'},date:new Date(Date.UTC(2003,9,5)),sources:{events:{noaa:{enabled:true},goes:{enabled:true},rhessi:{enabled:true}}},initialize:function(options){Object.extend(this,this.defaultOptions);Object.extend(this,options);this.dataNavigator=new DataNavigator(this);this.initViewports();this.initUI();this.initEvents();this.initKeyBoardListeners();},initUI:function(){this.calendar=new Calendar(this,'date','time');this.zoomControl=new ZoomControl(this,{id:'zoomControl',zoomLevel:this.defaultZoomLevel,minZoomLevel:this.minZoomLevel,maxZoomLevel:this.maxZoomLevel});this.timeStepSlider=new TimeStepSlider(this,'timestepHandle','timestepTrack','timeBackBtn','timeForwardBtn',this.timeIncrementSecs,8);this.messageConsole=new MessageConsole(this,'message-console','helioviewer-viewport-container-outer');this.eventLayerAccordion=new EventLayerAccordion(this.viewports[0],'eventAccordion');this.layerManager=new LayerManager(this.viewports[0],'layerManager');this.layerManager.render();this.initToolTips();},initViewports:function(){this.viewports=$A([new Viewport(this,{id:this.viewportId,zoomLevel:this.defaultZoomLevel,prefetch:this.defaultPrefetchSize,debug:false})]);var tileUrlPrefix=this.tileUrlPrefix;this.viewports.each(function(viewport){viewport.addLayer(new TileLayer(viewport,{tileUrlPrefix:tileUrlPrefix,observatory:'soho',instrument:'EIT',detector:'EIT',measurement:'195'}));viewport.addLayer(new TileLayer(viewport,{tileUrlPrefix:tileUrlPrefix,observatory:'soho',instrument:'LAS',detector:'0C2',measurement:'0WL'}));viewport.addLayer(new TileLayer(viewport,{tileUrlPrefix:tileUrlPrefix,observatory:'soho',instrument:'LAS',detector:'0C3',measurement:'0WL'}));Event.observe(window,'resize',viewport.resize.bind(viewport));});},initEvents:function(){this.observe(this.zoomControl,'change',this.handlers.zoom);this.observe(this.calendar,'observationDateChange',this.handlers.observationDateChange);this.observe(this.timeStepSlider,'timeIncrementChange',this.handlers.timeIncrementChange);this.observe(this.layerManager,'newLayer',this.handlers.newLayer);Event.observe(this.calendar.timeField,'change',this.handlers.observationTimeChange.bindAsEventListener(this));},initKeyBoardListeners:function(){var self=this;Event.observe(document,'keypress',function(e){if(e.target.tagName!=="INPUT"){var code;if(!e)var e=window.event;if(e.keyCode)code=e.keyCode;else if(e.which)code=e.which;var character=String.fromCharCode(code);if(character==="-"||character==="_"){self.zoomControl.zoomButtonClicked(+1);}
else if(character==="="||character==="+"){self.zoomControl.zoomButtonClicked(-1);}
else if(character==="c"){self.viewports.each(function(viewport){viewport.center();});}
else if(character==="d"){self.viewports[0].layers.each(function(layer){if(layer.type==="EventLayer"){layer.toggleLabelVisibility();}});}}});},initToolTips:function(){var items=$A(['#zoomControlZoomIn','#zoomControlZoomOut','#zoomControlHandle','#timestepHandle','#timeBackBtn','#timeForwardBtn']);var self=this;items.each(function(item){self.addToolTip(item,{yOffset:-125});});},addToolTip:function(id,params){var options=params||[];var classname="tooltip-"+(options.position||"bottomleft")+"-"+(options.tooltipSize||"medium");jQuery(id).tooltip({delay:(options.delay?options.delay:1000),track:(options.track?options.track:false),showURL:false,opacity:1,fixPNG:true,showBody:" - ",extraClass:classname,top:(options.yOffset?options.yOffset:0),left:12});},addViewport:function(viewport){this.viewports.push(viewport);return this;},observe:function(uielement,eventName,eventHandler){uielement.addObserver(eventName,eventHandler.bind(this));},setDate:function(date){this.date=date;this.viewports.each(function(viewport){viewport.reload();});},handlers:{zoom:function(level){this.viewports.each(function(viewport){viewport.zoomTo(level);});},observationDateChange:function(date){this.setDate(date);this.calendar.updateFields();},observationTimeChange:function(e){var time=e.target.value;var regex=/^\d{2}:\d{2}:\d{2}?/;if(time.match(regex)){var newTime=time.split(':');var hours=parseInt(newTime[0],10)-this.date.getUTCHours();var mins=parseInt(newTime[1],10)-this.date.getUTCMinutes();var secs=parseInt(newTime[2],10)-this.date.getUTCSeconds();this.date.addHours(hours);this.date.addMinutes(mins);this.date.setSeconds(secs);this.setDate(this.date);this.layerManager.updateTimeStamps();}else{this.messageConsole.warn('Invalid time. Please enter a time in of form HH:MM:SS');}},timeIncrementChange:function(timeIncrement){this.timeStepSlider.setTimeIncrement(timeIncrement);},newToolTip:function(tooltip){this.addToolTip(tooltip.id,tooltip.params);},newLayer:function(data){var inst=data.instrument;var ui=data.menuEntry;var viewport=this.viewports[0];var layer=new TileLayer(viewport,{tileUrlPrefix:this.tileUrlPrefix,observatory:inst.observatory,instrument:inst.instrument,detector:inst.detector,measurement:inst.measurement});viewport.addLayer(layer);ui.layer=layer;ui.displayTileLayerOptions();}}});String.prototype.padLeft=function(padding,minLength){var str=this;var strPad=''+padding;while(str.length<minLength){str=strPad+str;}
return str;};String.prototype.trimLeft=function(padding){var str=this;var strPad=''+padding;while(str[0]===strPad){str=str.substr(1);}
return str;};Date.prototype.toYmdUTCString=function(){var year=this.getUTCFullYear()+'';var month=(this.getUTCMonth()+1)+'';var day=this.getUTCDate()+'';return year+'/'+month.padLeft(0,2)+'/'+day.padLeft(0,2);};Date.prototype.toHmUTCString=function(){var hour=this.getUTCHours()+'';var min=this.getUTCMinutes()+'';var sec=this.getUTCSeconds()+'';return hour.padLeft(0,2)+':'+min.padLeft(0,2)+':'+sec.padLeft(0,2);};Date.prototype.toUTCDate=function(){var utcOffset=this.getUTCOffset();var sign=utcOffset[0];var hours=parseInt(utcOffset.substr(1,2));var mins=parseInt(utcOffset.substr(3,4));var numSecs=(3600*hours)+(60*mins);if(sign==="+"){numSecs=-numSecs;}
this.addSeconds(numSecs);};var LayerManager=Class.create(UIElement,{initialize:function(viewport,htmlContainer){this.className="LayerManager";this.controller=viewport.controller;this.viewport=viewport;this.container=$(htmlContainer);this.menuEntries=$A([]);this.createMenu();this.initEvents();this.controller.observe(this,'newToolTip',this.controller.handlers.newToolTip);this.viewport.layers.collect(this.addMenuEntry.bind(this));},createMenu:function(){this.header=Builder.node('span',{style:'float: left; color: black; font-weight: bold; '},'Layers');this.addLayerBtn=Builder.node('a',{href:'#',style:'margin-right:14px;',className:'gray'},'[Add Layer]');var div=Builder.node('div',{style:'text-align: right'},[this.header,this.addLayerBtn]);this.container.appendChild(div);this.accordionList=Builder.node('ul',{id:'layerManagerList'});var innerContainer=Builder.node('div',{id:'layerManager-Container'});innerContainer.appendChild(this.accordionList);this.container.appendChild(innerContainer);},initEvents:function(){Event.observe(this.addLayerBtn,'click',this.onAddLayerClick.bind(this));},render:function(){if(this.accordionDom){this.accordionDom.accordion("destroy");}
this.accordionDom=jQuery('#layerManager-Container').accordion({active:false,alwaysOpen:false,header:'div.layer-Head'});},addMenuEntry:function(layer){if(layer.type==="TileLayer"){this.menuEntries.push(new LayerManagerMenuEntry(this,layer));}},remove:function(layerEntry,layer){this.menuEntries=this.menuEntries.without(layerEntry);this.viewport.removeLayer(layer);},onAddLayerClick:function(){this.accordionDom.activate(-1);this.addMenuEntry({type:'NewLayer'});this.render();this.accordionDom.activate(this.menuEntries.length-1);},onLayerAdded:function(type,args){var layer=args[0];this.addMenuEntry(layer);this.render();},onLayerRemoved:function(type,args){},updateTimeStamps:function(){this.menuEntries.each(function(menuEntry){menuEntry.updateTimeStamp();});}});var LayerManagerMenuEntry=Class.create(UIElement,{initialize:function(layermanager,layer){this.className="layerManagerMenuEntry";this.layermanager=layermanager;this.layer=layer;this.domNode=Builder.node('li',{className:'accordionItem'});if(layer.type==="NewLayer"){this.displayNewLayerOptions();}
else if(layer.type==="TileLayer"){this.displayTileLayerOptions();}
this.layermanager.accordionList.appendChild(this.domNode);if(layer.type==="TileLayer"){this.layermanager.fire('newToolTip',{id:"#"+this.removeBtn.id,params:{position:'topleft'}});this.layermanager.fire('newToolTip',{id:"#"+this.visibilityBtn.id,params:{position:'topleft'}});}},displayTileLayerOptions:function(){if(!this.header){this.header=this.domNode.appendChild(this.createMenuRowHeader(this.layer));this.content=this.domNode.appendChild(this.createMenuRowContent(this.layer));}
else{this.header.replace(this.createMenuRowHeader(this.layer));this.content.replace(this.createMenuRowContent(this.layer));}
this.setupEventHandlers();this.updateTimeStamp(this.layer);},displayNewLayerOptions:function(){this.header=Builder.node('div',{className:'layer-Head'},"New Layer");this.content=Builder.node('div');this.domNode.appendChild(this.header);this.domNode.appendChild(this.content);var xhr=null;var self=this;var dn=self.layermanager.controller.dataNavigator;if(!dn.data.get('Instruments')){dn.query('Instruments');}
xhr=new Ajax.Updater(this.content,'getInstruments.php',{parameters:{type:'html'},method:'get',insertion:'bottom',onComplete:function(){var selectField=self.content.select('.instrument-select').first();var onInstChange=function(e){var chosenInstrument=null;for(var i=0;i<dn.data.get('Instruments').length;i++){if(dn.data.get('Instruments')[i].instrument===e.target.value){chosenInstrument=dn.data.get('Instruments')[i];}}
self.layermanager.fire('newLayer',{menuEntry:self,instrument:chosenInstrument});};Event.observe(selectField,'change',onInstChange.bind(self));}});},setupEventHandlers:function(){var toggleVisibility=function(e){var visible=this.layer.toggleVisible();var icon=(visible?'LayerManagerButton_Visibility_Visible.png':'LayerManagerButton_Visibility_Hidden.png');this.visibilityBtn.setStyle({background:'url(images/blackGlass/'+icon+')'});Event.stop(e);};var removeLayer=function(e){this.layermanager.remove(this,this.layer);Element.remove(this.domNode);Event.stop(e);this.layermanager.render();};Event.observe(this.visibilityBtn,'click',toggleVisibility.bindAsEventListener(this));Event.observe(this.removeBtn,'click',removeLayer.bindAsEventListener(this));this.layer.addObserver('obs_time_change',this.onLayerChange.bind(this));},createMenuRowHeader:function(layer){var header=Builder.node('div',{className:'layer-Head'});var instrument=Builder.node('span',{id:'layer-header-'+layer.id,style:'float: left; width: 33%;'},layer.instrument+(layer.instrument===layer.detector?"":"/"+layer.detector.trimLeft('0'))+" "+layer.measurement.trimLeft('0'));var timestamp=Builder.node('span',{className:'timestamp'});this.visibilityBtn=Builder.node('button',{id:'visibility-button-'+layer.id,className:'layerManagerBtn visible',value:true,type:'button',title:' - Toggle '+layer.instrument+' layer visibility.'});this.removeBtn=Builder.node('button',{id:'remove-button-'+layer.id,className:'layerManagerBtn remove',value:true,type:'button',title:' - Remove layer.'});var rightSide=Builder.node('div',{style:'text-align: right; float: left; width:67%;'},[timestamp," |",this.visibilityBtn,this.removeBtn]);var both=Builder.node('div',{style:'overflow: hidden;'},[instrument,rightSide]);header.appendChild(both);return header;},createMenuRowContent:function(layer){var body=Builder.node('div',{style:'color: white;'});var instLeft=Builder.node('div',{style:'float: left;  width: 40%;'},'Instrument: ');var instRight=Builder.node('div',{style:'float: right; width: 60%;'},this.createInstrumentControl(layer));body.appendChild(Builder.node('div',{style:'height: 24px; padding: 4px;',id:'instrument-row-'+layer.id},[instLeft,instRight]));return body;},listMeasurements:function(transport){var response=transport.responseJSON;this.layer.measurementType=response[0].type;this.layer.measurements=$A(response).collect(function(row){return parseInt(row.measurement,10);});},createInstrumentControl:function(layer){var inst=new Element('select',{id:'instrument-select-'+layer.id,style:'display: none'});inst.length=0;var instruments=$A(["EIT","LASCO"]);for(var i=0;i<instruments.length;i++){var opt=new Option(instruments[i]);opt.value=instruments[i];inst.options[inst.options.length]=opt;}
Event.observe(inst,'change',this.onInstrumentChange.curry(layer.id));var instText=Builder.node('span',{id:'instrument-text-'+layer.id},layer.instrument);return instText;},onInstrumentChange:function(id){var header=$('layer-header-'+id);var measurement=$('wavelength-select-'+id);var measurementRow=$('measurement-row-'+id);var instText=$('instrument-text-'+id);if(this.value==="LASCO"){measurementRow.hide();header.update("LASCO");}
else{header.update(this.value+" "+measurement.value);measurementRow.show();}
instText.update(this.value);document.instrumentChange.fire(id,this.value);},onLayerChange:function(layer){this.updateTimeStamp(layer);},createWavelengthControl:function(layer){var id=layer.id;var wl=new Element('select',{id:'wavelength-select-'+id,style:'display: none'});wl.length=0;var wavelengths=$A([171,195,284]);for(var i=0;i<wavelengths.length;i++){var opt=new Option(wavelengths[i]);opt.value=wavelengths[i];wl.options[wl.options.length]=opt;}
Event.observe(wl,'change',this.onWavelengthChange.curry(id));var wlText=Builder.node('span',{id:'wavelength-text-'+id},layer.measurement);Event.observe(wlText,'click',function(e){$(e.target).hide();wl.show();});Event.observe(wl,'blur',function(e){$(e.target).hide();wlText.show();});return[wl,wlText];},onWavelengthChange:function(id){var inst=$('instrument-select-'+id);var header=$('layer-header-'+id);header.update(inst.value+" "+this.value);$('wavelength-text-'+id).update(this.value);document.wavelengthChange.fire(id,this.value);},createOpacityControl:function(id){var opacity=100;var opacityInput=new Element('input',{size:'3',value:opacity});Event.observe(opacityInput,'change',function(){document.opacityChange.fire(id,parseInt(this.value,10)/100);});return opacityInput;},createEnabledBox:function(id){var enabledTd=new Element('td',{style:"padding-left:15px;"});var enabled=new Element('input',{type:'checkbox',checked:'true',name:'enabled'});enabledTd.appendChild(enabled);Event.observe(enabled,'click',this.onEnabledBoxClick.bind(this,id));return enabledTd;},updateTimeStamp:function(){if(this.layer.timestamp===undefined){return;}
$(this.domNode).select(".timestamp").first().removeClassName("timeBehind");$(this.domNode).select(".timestamp").first().removeClassName("timeAhead");$(this.domNode).select(".timestamp").first().removeClassName("timeSignificantlyOff");var date=new Date(this.layer.timestamp*1000);var dateString=date.toYmdUTCString()+' '+date.toHmUTCString();var timeDiff=this.layer.timestamp-this.layermanager.controller.date.getTime()/1000;$(this.domNode).select(".timestamp").first().update(dateString);var ts=this.layermanager.controller.timeStepSlider.timestep.numSecs;if(timeDiff<0){if(Math.abs(timeDiff)>(4*ts)){$(this.domNode).select(".timestamp").first().addClassName("timeSignificantlyOff");}
else{$(this.domNode).select(".timestamp").first().addClassName("timeBehind");}}
else if(timeDiff>0){if(timeDiff>(4*ts)){$(this.domNode).select(".timestamp").first().addClassName("timeSignificantlyOff");}
else{$(this.domNode).select(".timestamp").first().addClassName("timeAhead");}}}});var MessageConsole=Class.create(UIElement,{initialize:function(controller,container,viewport){this.controller=controller;this.console=$(container);this.viewportId=viewport;this.observe(this.controller.viewports[0],'info',this.log);},log:function(msg){this.console.update(new Element('p',{style:'color: #6495ED'}).insert(msg));var trash=new Effect.Appear(this.console,{duration:3.0});var self=this;window.setTimeout(function(){var trash=new Effect.Fade(self.console,{duration:3.0});},6500);},info:function(msg){},warn:function(msg){this.console.update(new Element('p',{style:'color: yellow; font-weight: bolder;'}).insert(msg));var trash=new Effect.Appear(this.console,{duration:3.0});var self=this;window.setTimeout(function(){var trash=new Effect.Fade(self.console,{duration:3.0});},6500);},error:function(msg){this.console.update(new Element('p',{style:'color: red'}).insert(msg));var trash=new Effect.Shake(this.viewportId,{distance:15,duration:0.1});trash=new Effect.Appear(this.console,{duration:3.0});var self=this;window.setTimeout(function(){var trash=new Effect.Fade(self.console,{duration:3.0});},6500);},observe:function(uielement,eventName,eventHandler){uielement.addObserver(eventName,eventHandler.bind(this));}});var TileLayer=Class.create(Layer,{defaultOptions:{type:'TileLayer',tileSize:512,source:'database',rootDir:'tiles/',opacity:1},initialize:function(viewport,options){Object.extend(this,this.defaultOptions);Object.extend(this,options);this.viewport=viewport;this.id='tilelayer'+Math.floor(Math.random()*100000+1);this.domNode=new Element('div',{className:'tile-layer-container',style:'position: absolute;'});viewport.movingContainer.appendChild(this.domNode);this.viewport.addObserver('move',this.viewportMove.bind(this));this.tiles=[];if(this.imageId){Debug.output("imageId assigned!");this.loadImageProperties();}else{this.loadClosestImage();}},reload:function(){this.loadClosestImage();},removeTiles:function(){this.tiles=[];},reset:function(visible){var i,j;this.removeTiles();this.refreshUTCDate();var old=[];this.domNode.childElements().each(function(tile){old.push(tile);});var numTiles=0;var numTilesLoaded=0;var indices=this.viewport.visibleRange;for(i=indices.xStart;i<=indices.xEnd;i++){for(j=indices.yStart;j<=indices.yEnd;j++){if(visible[i][j]){var tile=$(this.domNode.appendChild(this.getTile(i,j,this.viewport.zoomLevel)));if(!this.tiles[i]){this.tiles[i]=[];}
this.tiles[i][j]={};this.tiles[i][j].img=tile;numTiles++;Event.observe(this.tiles[i][j].img,'load',function(e){numTilesLoaded++;if(numTilesLoaded==numTiles){old.each(function(tile){tile.parentNode&&tile.remove();});}});}}}},refreshUTCDate:function(){var date=new Date(this.timestamp*1000);date.toUTCDate();this.utcDate=date;},setImageProperties:function(imageProperties){if(imageProperties.imageId===this.imageId){this.fire('obs_time_change',this);return;}
Object.extend(this,imageProperties);this.fire('obs_time_change',this);this.setInitialOpacity();this.fire('change',this);this.viewport.checkTiles(true);this.reset(this.viewport.visible);},loadImageProperties:function(){Debug.output("LOAD IMAGE PROPERTIES CALLED!");var urlPrefix=this.viewport.controller.imageUrlPrefix;var url=urlPrefix+'?action=getProperties&imageId='+this.imageId;var processResponse=function(transport){this.setImageProperties(transport.responseJSON);};var trash=new Ajax.Request(url,{method:'get',onSuccess:processResponse.bind(this)});},setImage:function(imageId){if(imageId===this.imageId){return;}
this.imageId=imageId;this.loadImageProperties();this.reset(this.viewport.visible);},setInitialOpacity:function(){this.setZIndex(parseInt(this.opacityGroupId));var self=this;var opacity=1;var counter=0;this.viewport.layers.each(function(layer){if(parseInt(layer.opacityGroupId)==parseInt(self.opacityGroupId)){counter++;if(counter>1){opacity=opacity/counter;layer.domNode.setOpacity(opacity);layer.domNode.setStyle({'filter':'alpha(opacity='+(opacity*100)+')',width:self.tileSize})}}});},loadClosestImage:function(){var date=this.viewport.controller.date;var urlPrefix=this.viewport.controller.imageUrlPrefix;var url=urlPrefix+'?action=getClosest&observatory='+this.observatory+'&instrument='+this.instrument+'&detector='+this.detector+'&measurement='+this.measurement+'&timestamp='+(date.getTime()/1000);var processResponse=function(transport){this.setImageProperties(transport.responseJSON);};var xhr=new Ajax.Request(url,{method:'get',onSuccess:processResponse.bind(this)});},viewportMove:function(position){var visible=this.viewport.visible;var indices=this.viewport.visibleRange;for(var i=indices.xStart;i<=indices.xEnd;i++){for(var j=indices.yStart;j<=indices.yEnd;j++){if(!this.tiles[i]){this.tiles[i]=[];}
if(visible[i][j]&&(!this.tiles[i][j])){this.tiles[i][j]=$(this.domNode.appendChild(this.getTile(i,j,this.viewport.zoomLevel)));}}}},getFullSize:function(){return Math.max(this.tileSize*2,Math.pow(2,this.maxZoomLevel-this.viewport.zoomLevel));},getTile:function(x,y){var left=x*this.tileSize;var top=y*this.tileSize;var img=$(new Image());img.toggleClassName('tile');img.setStyle({left:left+'px',top:top+'px'});img.unselectable='on';var rf=function(){return false;};img.onmousedown=rf;img.ondrag=rf;img.onmouseover=rf;img.oncontextmenu=rf;img.galleryimg='no';Event.observe(img,'error',function(){this.src='images/transparent.gif';})
img.src=this.getTileUrl(x,y,this.detector,this.viewport.zoomLevel,this.imageId);return img;},getTileUrl:function(x,y,detector,zoom,imageId){if(this.source==="database"){if(imageId===undefined){imageId='';}
return this.tileUrlPrefix+'?x='+x+'&y='+y+'&detector='+detector+'&zoom='+zoom+'&imageId='+imageId;}
else if(this.source==="filesystem"){var filepath=this.getFilePath(x,y);return filepath;}},getFilePath:function(x,y){var offset=this.getTileOffset();var year=this.utcDate.getFullYear();var month=(this.utcDate.getMonth()+1).toString().padLeft('0',2);var day=this.utcDate.getDate().toString().padLeft('0',2);var hour=this.utcDate.getHours().toString().padLeft('0',2);var min=this.utcDate.getMinutes().toString().padLeft('0',2);var sec=this.utcDate.getSeconds().toString().padLeft('0',2);var obs=this.observatory;var inst=this.instrument;var det=this.detector;var meas=this.measurement;var zoom=this.viewport.zoomLevel;x=(x+offset).toString().padLeft('0',2);y=(y+offset).toString().padLeft('0',2);var path=this.rootDir+year+"/"+month+"/"+day+"/"+hour+"/"+obs+"/"+inst+"/"+det+"/"+meas+"/";var file=year+"_"+month+"_"+day+"_"+hour+min+sec+"_"+obs+"_"+inst+"_"+det+"_"+meas+"-"+zoom+"-"+x+"-"+y+"."+this.filetype;return(path+file);},getTileOffset:function(){var numTiles=this.getNumTiles();return Math.max(1,parseInt(Math.sqrt(numTiles)/2));},getNumTiles:function(){var zoom=this.viewport.zoomLevel;var diff=parseInt(this.lowestRegularZoom)-zoom;Debug.output("TL Diff: "+diff);return Math.max(4,Math.pow(4,1+diff));}});var TimeStepSlider=Class.create(UIElement,{initialize:function(controller,sliderHandleId,sliderTrackId,backBtn,forwardBtn,timeIncrement,initialIndex){this.controller=controller;this.slider=new Control.Slider(sliderHandleId,sliderTrackId,{axis:'horizontal',range:$R(1,10),values:[1,2,3,4,5,6,7,8,9,10],sliderValue:initialIndex,onChange:this.onChange.bindAsEventListener(this),onSlide:this.onSlide.bindAsEventListener(this)});this.className="TimeStepSlider";this.lastIndex=initialIndex;this.timestep=this.indexToTimeStep(initialIndex);this.timeIncrement=timeIncrement;Event.observe(backBtn,'click',this.timePrevious.bind(this));Event.observe(forwardBtn,'click',this.timeNext.bind(this));},indexToTimeStep:function(index){var timeSteps=[{numSecs:1,txt:"1&nbsp;Sec"},{numSecs:1,txt:"1&nbsp;Sec"},{numSecs:60,txt:"1&nbsp;Min"},{numSecs:300,txt:"5&nbsp;Mins"},{numSecs:900,txt:"15&nbsp;Mins"},{numSecs:3600,txt:"1&nbsp;Hour"},{numSecs:21600,txt:"6&nbsp;Hours"},{numSecs:43200,txt:"12&nbsp;Hours"},{numSecs:86400,txt:"1&nbsp;Day"},{numSecs:604800,txt:"1&nbsp;Week"},{numSecs:2419200,txt:"28&nbsp;Days"}];return timeSteps[index];},onChange:function(index){if(index!==null){this.timestep=this.indexToTimeStep(index);this.fire('timeIncrementChange',this.timestep.numSecs);}},onSlide:function(index){if((index!==null)&&(index!==this.lastIndex)){this.lastIndex=index;$('timestepValueDisplay').update(this.indexToTimeStep(index).txt);}},setTimeIncrement:function(timeIncrement){this.timeIncrement=timeIncrement;},timePrevious:function(){var newDate=this.controller.date.addSeconds(-this.timeIncrement);this.controller.setDate(newDate);this.controller.calendar.updateFields();},timeNext:function(){var newDate=this.controller.date.addSeconds(this.timeIncrement);this.controller.setDate(newDate);this.controller.calendar.updateFields();}});var Viewport=Class.create(UIElement,{defaultOptions:{zoomLevel:0,headerId:'middle-col-header',footerId:'footer',tileSize:512,debug:true,prefetch:0},isMoving:false,dimensions:{width:0,height:0},initialize:function(controller,options){Object.extend(this,this.defaultOptions);Object.extend(this,options);this.domNode=$(this.id);this.outerNode=$(this.id+'-container-outer');this.controller=controller;this.layers=$A([]);this.ViewportHandlers=new ViewportHandlers(this);this.headerAndFooterHeight=$(this.headerId).getDimensions().height+$(this.footerId).getDimensions().height+4;var center=this.getCenter();this.movingContainer=$(this.domNode.appendChild(Builder.node('div',{className:'movingContainer'})));this.movingContainer.setStyle({'left':center.x+'px','top':center.y+'px'});if(this.debug){this.movingContainer.setStyle({'border':'1px solid red'});var centerBox=new Element('div',{style:'position: absolute; width: 50px; height: 50px; border: 1px dashed red; '});centerBox.setStyle({'left':(center.x-25)+'px','top':(center.y-25)+'px'});this.domNode.insert(centerBox);}
this.resize();},center:function(){var center=this.getCenter();this.moveTo(center.x,center.y);},moveTo:function(x,y){this.movingContainer.setStyle({left:x+'px',top:y+'px'});this.checkTiles();this.fire('move',{x:x,y:y});},moveBy:function(x,y){var pos={x:this.startMovingPosition.x-x,y:this.startMovingPosition.y-y};this.movingContainer.setStyle({left:pos.x+'px',top:pos.y+'px'});this.checkTiles();this.fire('move',{x:pos.x,y:pos.y});},startMoving:function(){this.startMovingPosition=this.getContainerPos();},getCenter:function(){return{x:Math.round(this.domNode.getWidth()/2),y:Math.round(this.domNode.getHeight()/2)}},getContainerPos:function(){return{x:parseInt(this.movingContainer.getStyle('left')),y:parseInt(this.movingContainer.getStyle('top'))}},currentPosition:function(){return this.getContainerPos();},helioCenter:function(){return this.getContainerPos();},endMoving:function(){},checkTiles:function(){this.visible=[];var indices=this.displayRange();for(i=indices.xStart;i<=indices.xEnd;i++){for(j=indices.yStart;j<=indices.yEnd;j++){if(!this.visible[i]){this.visible[i]=[];}
this.visible[i][j]=true;}}},displayRange:function(){var vp=this.getHCViewportPixelCoords();var ts=this.tileSize;vp={top:vp.top-ts-(vp.top%ts),left:vp.left-ts-(vp.left%ts),bottom:vp.bottom+ts-(vp.bottom%ts),right:vp.right+ts-(vp.right%ts)}
this.visibleRange={xStart:vp.left/ts,xEnd:vp.right/ts,yStart:vp.top/ts,yEnd:vp.bottom/ts}
return this.visibleRange;},getViewportPixelCoords:function(){var dimensions=this.domNode.getDimensions();return{top:-this.prefetch,left:-this.prefetch,bottom:dimensions.height+this.prefetch,right:dimensions.width+this.prefetch}},getHCViewportPixelCoords:function(){var vp=this.getViewportPixelCoords();var hc=this.helioCenter();vp.top-=hc.y;vp.left-=hc.x;vp.bottom-=hc.y;vp.right-=hc.x;return vp;},zoomTo:function(zoomLevel){this.zoomLevel=zoomLevel;this.resetLayers();},resize:function(){var oldDimensions=this.dimensions;var viewportOuter=this.outerNode;viewportOuter.setStyle({height:document.viewport.getHeight()-this.headerAndFooterHeight+'px'});this.dimensions=this.domNode.getDimensions();this.dimensions.width+=this.prefetch;this.dimensions.height+=this.prefetch;if(this.dimensions.width!==oldDimensions.width||this.dimensions.height!==oldDimensions.height){if(this.layers.length>0){this.resetLayers();}}},addLayer:function(layer){this.layers.push(layer);},removeLayer:function(layer){layer.domNode.remove();this.layers=this.layers.without(layer);},reload:function(){this.layers.each(function(layer){layer.reload();});},resetLayers:function(){var self=this;this.checkTiles();this.layers.each(function(layer){layer.reset(self.visible);});}});var ViewportHandlers=Class.create({startingPosition:{x:0,y:0},mouseStartingPosition:{x:0,y:0},mouseCurrentPosition:{x:0,y:0},moveCounter:0,moveThrottle:2,initialize:function(viewport){this.viewport=viewport;this.bMouseMove=this.mouseMove.bindAsEventListener(this);this.bMouseDown=this.mouseDown.bindAsEventListener(this);this.bMouseUp=this.mouseUp.bindAsEventListener(this);Event.observe(window,'mousemove',this.bMouseMove);Event.observe(document,'mousemove',this.bMouseMove);Event.observe(this.viewport.domNode,'mousedown',this.bMouseDown);Event.observe(window,'mouseup',this.bMouseUp);Event.observe(document,'mouseup',this.bMouseUp);Event.observe(this.viewport.domNode,'dblclick',this.doubleClick.bindAsEventListener(this));Event.observe(document,'keypress',this.keyPress.bindAsEventListener(this));Event.observe(window,'keypress',this.keyPress.bindAsEventListener(this));},mouseDown:function(event){this.viewport.isMoving=true;this.startingPosition=this.viewport.currentPosition();this.mouseStartingPosition={x:Event.pointerX(event),y:Event.pointerY(event)};this.viewport.domNode.setStyle({cursor:'all-scroll'});if(this.viewport.domNode.setCapture){this.viewport.domNode.setCapture();}
this.viewport.startMoving();},doubleClick:function(e){var viewport=this.viewport;if((e.shiftKey||(viewport.zoomLevel>viewport.controller.minZoomLevel))&&(viewport.zoomLevel<viewport.controller.maxZoomLevel)){if(e.isLeftClick()){var xOffset=$('left-col').getDimensions().width+Math.round(0.03*viewport.outerNode.getDimensions().width)+2;var yOffset=$(viewport.headerId).getDimensions().height+Math.round(0.03*viewport.outerNode.getDimensions().height)+3;var mouseCoords={x:e.pointerX()-xOffset,y:e.pointerY()-yOffset}
var containerPos=viewport.getContainerPos();var x=mouseCoords.x-containerPos.x;var y=mouseCoords.y-containerPos.y;viewport.center();this.viewport.startMoving();if(e.shiftKey){viewport.moveBy(0.5*x,0.5*y);viewport.controller.zoomControl.zoomButtonClicked(1);}
else{viewport.moveBy(2*x,2*y);viewport.controller.zoomControl.zoomButtonClicked(-1);}}}else{Debug.output("Out of bounds double-click request! See Viewport.js:57");}},keyPress:function(e){var key=e.keyCode;if(e.target.tagName!=="INPUT"){if(key==37||key==38||key==39||key==40){this.startingPosition=this.viewport.currentPosition();this.viewport.startMoving();this.moveCounter=(this.moveCounter+1)%this.moveThrottle;if(this.moveCounter!==0){return;}
if(key==37){this.viewport.moveBy(8,0);}
else if(e.keyCode==38){this.viewport.moveBy(0,8);}
else if(e.keyCode==39){this.viewport.moveBy(-8,0);}
else if(e.keyCode==40){this.viewport.moveBy(0,-8);}}}},mouseUp:function(event){this.viewport.isMoving=false;this.viewport.domNode.setStyle({cursor:'pointer'});if(this.viewport.domNode.releaseCapture){this.viewport.domNode.releaseCapture();}
this.viewport.endMoving();},keyRelease:function(event){this.viewport.isMoving=false;this.viewport.endMoving();},mouseMove:function(event){if(!this.viewport.isMoving){return;}
this.moveCounter=(this.moveCounter+1)%this.moveThrottle;if(this.moveCounter!==0){return;}
this.mouseCurrentPosition={x:Event.pointerX(event),y:Event.pointerY(event)};this.viewport.moveBy(this.mouseStartingPosition.x-this.mouseCurrentPosition.x,this.mouseStartingPosition.y-this.mouseCurrentPosition.y);}});var ZoomControl=Class.create(UIElement,{initialize:function(controller,options){Object.extend(this,options);this.controller=controller;this.domNode=$(this.id);this.handle=$(this.id+'Handle');var range=$R(this.minZoomLevel,this.maxZoomLevel);this.slider=new Control.Slider(this.handle,this.id+'Track',{axis:'vertical',values:range,sliderValue:this.zoomLevel,range:range,onChange:this.changed.bind(this)});Event.observe($(this.id+'ZoomIn'),'click',this.zoomButtonClicked.bind(this,-1));Event.observe($(this.id+'ZoomIn'),'mousedown',function(e){Event.stop(e);});Event.observe($(this.id+'ZoomOut'),'mouseup',this.zoomButtonClicked.bind(this,1));Event.observe($(this.id+'ZoomOut'),'mousedown',function(e){Event.stop(e);});},zoomButtonClicked:function(dir){this.slider.setValue(this.slider.value+dir);},changed:function(v){this.fire('change',v);}});__INSTRUMENTS__={'EIT':{'dataAvailability':{'startDate':new Date(Date.UTC(2003,9,5)),'endDate':new Date(Date.UTC(2003,9,6)),'minZoom':12,'maxZoom':20},'measurements':{'type':'wavelength'}}};