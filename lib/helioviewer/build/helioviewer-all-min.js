
var LoadingIndicator=Class.create({initialize:function(){this.loadingItems=[];Ajax.Responders.register({onCreate:this.loadingStarted.bind(this,'Ajax'),onComplete:this.loadingFinished.bind(this,'Ajax')});},show:function(){$('loading').show();},hide:function(){$('loading').hide();},reset:function(){this.loadingItems.length=0;this.hide();},loadingStarted:function(e){this.show();this.loadingItems.push({});},loadingFinished:function(i){this.loadingItems.pop();if(this.loadingItems.length===0){this.hide();}}});var UIElement=Class.create({initialize:function(){},addObserver:function(eventName,callback){if(!this.observers){this.observers=[];}
if(!this.observers[eventName]){this.observers[eventName]=$A([]);}
this.observers[eventName].push(callback);return this;},fire:function(eventName,eventParameters){if(!this.observers||!this.observers[eventName]||this.observers[eventName].length===0){return this;}
this.observers[eventName].each(function(callback){callback(eventParameters);});return this;}});var Layer=Class.create(UIElement,{maxZoomLevel:20,minZoomLevel:10,visible:true,initialize:function(viewport){this.viewport=viewport;this.domNode=$(viewport.movingContainer.appendChild(new Element('div')));this.viewport.addObserver('move',this.viewportMove.bind(this));this.id='layer'+Math.floor(Math.random()*100000+1);},setZIndex:function(val){this.domNode.setStyle({zIndex:val});},setVisible:function(visible){this.visible=visible;this.domNode.setStyle({visibility:(visible?'visible':'hidden')});return this.visible;},toggleVisible:function(){return this.setVisible(!this.visible);}});var Calendar=Class.create(UIElement,{initialize:function(controller,dateFieldId,timeFieldId){this.controller=controller;this.dateField=$(dateFieldId);this.timeField=$(timeFieldId);var self=this;this.cal=jQuery("#"+dateFieldId).datepicker({buttonImage:'images/blackGlass/calendar_small.png',buttonImageOnly:true,buttonText:"Select a date.",changeYear:true,dateFormat:'yy/mm/dd',mandatory:true,showOn:'both',yearRange:'1998:2009',onSelect:function(dateStr){window.setTimeout(function(){var time=self.timeField.value,date=Date.parse(dateStr),hours=parseInt(time.substring(0,2),10),minutes=parseInt(time.substring(3,5),10),seconds=parseInt(time.substring(6,8),10),utcDate=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate(),hours,minutes,seconds));self.fire('observationDateChange',utcDate);},500);}});jQuery('.ui-datepicker-trigger').hover(function(){jQuery(this).attr("src","images/blackGlass/calendar_small-hover.png");},function(){jQuery(this).attr("src","images/blackGlass/calendar_small.png");});},updateFields:function(){this.dateField.value=this.controller.date.toYmdUTCString();this.timeField.value=this.controller.date.toHmUTCString();}});var EventLayer=Class.create(Layer,{defaultOptions:{type:'EventLayer',sunRadius0:94*(1<<12),opacityGroupId:-1,displayLabels:false,windowSize:43200,eventMarkerOffset:{top:10,left:0}},initialize:function(viewport,options){Object.extend(this,this.defaultOptions);Object.extend(this,options);this.viewport=viewport;this.id='eventlayer'+new Date().getTime();this.events=$A([]);this.domNode=new Element('div',{className:'event-layer'});this.viewport.movingContainer.appendChild(this.domNode);this.eventAccordion.addLayer(this);this.queryEvents();},queryEvents:function(){var processResponse=function(transport){this.clear();if(transport.responseJSON){this.displayEvents(transport.responseJSON);}},xhr,queryDate=null;if(navigator.userAgent.search(/3\.5/)!==-1){queryDate=this.viewport.controller.date.toISOString();}
else{queryDate=this.viewport.controller.date.toISOString().slice(1,-1);}
xhr=new Ajax.Request(this.viewport.controller.api,{method:'POST',onSuccess:processResponse.bind(this),parameters:{action:'getEvents',date:queryDate,windowSize:this.windowSize,catalogs:this.catalog}});},viewportMove:function(){},clear:function(){this.events.each(function(e){e.remove();});this.events.clear();},displayEvents:function(jsonEvents){var self=this,date=this.viewport.controller.date,UTCOffset=-parseInt(date.getTimezoneOffset(),10)*60,sunRadius=this.sunRadius0>>this.viewport.zoomLevel;$A(jsonEvents).each(function(event){self.events.push(new EventMarker(self,event,date,UTCOffset,sunRadius,{offset:self.eventMarkerOffset}));});},updateIcon:function(newIcon){this.icon="small-"+newIcon;var type=this.eventAccordion.eventCatalogs.get(this.catalog).eventType.gsub(' ',"_"),url='url(images/events/small-'+newIcon+'-'+type+'.png)';this.events.each(function(event){event.marker.setStyle({'background':url});});jQuery('#event-icon-'+this.id).css('background',url);this.eventAccordion.eventIcons[this.catalog]="small-"+newIcon;this.viewport.controller.userSettings.set('event-icons',this.eventAccordion.eventIcons);},toggleLabelVisibility:function(){this.displayLabels=!this.displayLabels;this.events.each(function(e){e.toggleLabel();});},reload:function(){this.queryEvents();},reset:function(){var sunRadius=this.sunRadius0>>this.viewport.zoomLevel;this.events.each(function(e){e.refresh(sunRadius);});}});var EventLayerAccordion=Class.create(Layer,{initialize:function(viewport,containerId){this.viewport=viewport;this.container=jQuery('#'+containerId);this.eventIcons=this.viewport.controller.userSettings.get('event-icons');this._setupUI();this.iconPicker=new IconPicker('event-icon-menu');this.domNode=jQuery('#EventLayerAccordion-Container');this.domNode.dynaccordion();this.getEventCatalogs();},addLayer:function(layer){var catalog=this.eventCatalogs.get(layer.catalog),etype=catalog.eventType.gsub(' ','_'),icon,visibilityBtn,removeBtn,head,body;layer.icon=this.eventIcons[catalog.id]||'small-blue-circle';icon="<span class=accordion-header-divider>|</span><button class='event-accordion-icon' id='event-icon-"+layer.id+"' style='background: url(images/events/"+layer.icon+"-"+etype+".png);'></button>";visibilityBtn="<span class='layerManagerBtn visible' id='visibilityBtn-"+layer.id+"' title='toggle layer visibility'></span>";removeBtn="<span class='ui-icon ui-icon-closethick removeBtn' id='removeBtn-"+layer.id+"' type=button title='remove layer'></span>";head="<div class='layer-Head ui-accordion-header ui-helper-reset ui-state-default ui-corner-all'><span class=event-accordion-header-left>"+catalog.name+"</span><span class=event-accordion-header-right>"+icon+visibilityBtn+removeBtn+"</span></div>";body='<div style="color: white; position: relative;">'+catalog.description+'</div>';this.domNode.dynaccordion("addSection",{id:layer.id,header:head,cell:body});this._setupEventHandlers(layer);},getEventCatalogs:function(){var processResponse=function(transport){var lm=this.viewport.controller.layerManager,catalogs=transport.responseJSON,self=this
if(typeof(catalogs)!=="undefined"){this.eventCatalogs=new Hash();catalogs.each(function(catalog){if(catalog.id!=="EITPlanningService::EITActivity"){self.eventCatalogs.set(catalog.id,catalog);}});lm.addLayer(new EventLayer(this.viewport,{catalog:"VSOService::cmelist",eventAccordion:this}));lm.addLayer(new EventLayer(this.viewport,{catalog:"GOESXRayService::GOESXRay",eventAccordion:this}));lm.addLayer(new EventLayer(this.viewport,{catalog:"VSOService::noaa",eventAccordion:this,windowSize:86400}));}else{this._catalogsUnavailable();}},xhr=new Ajax.Request(this.viewport.controller.api,{method:"POST",parameters:{action:"getEventCatalogs"},onSuccess:processResponse.bind(this)});},_setupUI:function(){var title=jQuery('<span class="section-header">Features/Events</span>').css({'float':'left'}),addLayerBtn=jQuery('<a href=# class=dark>[Add]</a>').css({'margin-right':'14px'}),self=this;this.container.append(jQuery('<div></div>').css('text-align','right').append(title).append(addLayerBtn));this.container.append(jQuery('<div id="EventLayerAccordion-Container"></div>'));addLayerBtn.click(function(){if(typeof(self.eventCatalogs)!=="undefined"){var select=self._buildCatalogSelect(),okayBtn="<button>Ok</button>",tmpId='tmp'+new Date().getTime();self.domNode.dynaccordion("addSection",{id:tmpId,header:'<div class="layer-Head">Select catalog to use:</div>',cell:select+okayBtn,open:true});Event.observe($(tmpId).select('button').first(),'click',function(e){var select=$(tmpId).select('select').first();self.domNode.dynaccordion('removeSection',{id:tmpId});self.viewport.controller.layerManager.addLayer(new EventLayer(self.viewport,{catalog:select.value,eventAccordion:self}));});}else{}});},_buildCatalogSelect:function(){var self=this,select="<select class='event-layer-select' style='margin:5px;'>";this.eventCatalogs.each(function(catalog){if(!self.viewport.controller.layerManager.hasEventCatalog(catalog.key)){select+="<option value="+catalog.key+">"+catalog.value.name+"</option>";}});select+="</select>";return select;},_catalogsUnavailable:function(){$('eventAccordion').select('a.gray')[0].update("");var head="<div class='layer-Head'>Currently Unavailable</div>",body="<span style='color: #FFF;'>Helioviewer's Feature/Event catalog system is currently unavailable. Please try again later.</span>";this.domNode.dynaccordion("addSection",{id:404,header:head,cell:body});},_setupEventHandlers:function(layer){var visibilityBtn=jQuery("#visibilityBtn-"+layer.id),removeBtn=jQuery("#removeBtn-"+layer.id),eventIcon=jQuery("#event-icon-"+layer.id),self=this,toggleVisibility=function(e){var visible=layer.toggleVisible(),icon=(visible?'LayerManagerButton_Visibility_Visible.png':'LayerManagerButton_Visibility_Hidden.png');jQuery("#visibilityBtn-"+layer.id).css('background','url(images/blackGlass/'+icon+')');e.stopPropagation();},removeLayer=function(e){var self=e.data;self.viewport.controller.layerManager.removeLayer(layer);self.domNode.dynaccordion('removeSection',{id:layer.id});e.stopPropagation();},showIconMenu=function(e){layer=e.data;self.iconPicker.toggle(layer,jQuery(this).position());e.stopPropagation();};visibilityBtn.bind('click',this,toggleVisibility);removeBtn.bind('click',this,removeLayer);eventIcon.bind('click',layer,showIconMenu);}});var EventMarker=Class.create({initialize:function(eventLayer,event,date,utcOffset,sunRadius,options){Object.extend(this,event);Object.extend(this,options);this.eventLayer=eventLayer;this.appDate=date;this.utcOffset=utcOffset;this.sunRadius=sunRadius;var catalogs=eventLayer.eventAccordion.eventCatalogs;this.catalogName=catalogs.get(this.catalogId).name;this.type=catalogs.get(this.catalogId).eventType;this.pos={x:this.sunX*sunRadius,y:this.sunY*sunRadius};this.container=this.eventLayer.domNode.appendChild(new Element('div',{className:'event',style:'left: '+(this.pos.x)+'px; top: '+(this.pos.y)+'px;'}));this.createMarker();this.createLabel();this.createPopup();},createMarker:function(){var cssType=this.type.gsub(' ',"_"),marker=new Element('div',{className:'event-marker'});marker.setStyle({'background':'url(images/events/'+this.eventLayer.icon+"-"+cssType+'.png)'});this.marker=marker;this.container.appendChild(marker);},createLabel:function(){var display=this.eventLayer.viewport.controller.layerManager.getLabelVisibility(),labelText=this.getLabelText(this.type),eventDate=Date.parse(this.time.startTime.substr(0,19)).addSeconds(this.utcOffset),timeDiff=eventDate.getTime()-this.appDate.getTime(),label=new Element('div',{className:'event-label'}).setStyle({'display':display}).insert(labelText);if(timeDiff<0){label.addClassName("timeBehind");}
else if(timeDiff>0){label.addClassName("timeAhead");}
this.label=label;this.container.appendChild(label);},getLabelText:function(eventType){var labelText=null;switch(eventType){case"Active Region":labelText=this.eventId;break;case"CME":labelText=this.time.startTime;break;case"Type II Radio Burst":labelText=this.time.startTime;break;default:labelText=this.time.startTime;break;}
return labelText;},createPopup:function(){var properties=$H(this.properties),t,content="<div class='event-popup-container'>"+"<strong>"+this.type+" "+this.eventId+"</strong><br>"+"<p>"+this.catalogName+"</p><br>"+"<strong>start:</strong> "+this.time.startTime+"<br>"+"<strong>end:</strong> "+this.time.endTime+"<br><br>";properties.keys().each(function(key){content+="<strong>"+key+":</strong> "+properties.get(key);if(key.search(/angle/i)!==-1){content+="&deg;";}
content+="<br>";});content+="<strong>Source:</strong> <a href='"+this.sourceUrl+"' class='event-url' target='_blank'>"+this.sourceUrl+"</a><br></div>";t=new Tip(this.container,content,{title:'Details:',style:'protogrey',stem:'topLeft',closeButton:true,showOn:'click',hideOn:'click',hook:{target:'bottomRight',tip:'topLeft'},offset:{x:14,y:14}});this.container.observeOnce('click',function(e){var tip=$$('body > .prototip');if(tip.length>0){this.insert(tip.first().remove().setStyle({'top':'12px','left':'8px'}));Event.observe(this,'click',function(e){$(this.select('.prototip')).first().setStyle({'top':'12px','left':'8px'});});}});},remove:function(){this.container.remove();},refresh:function(sunRadius){this.sunRadius=sunRadius;this.pos={x:this.sunX*sunRadius,y:this.sunY*sunRadius};this.container.setStyle({left:(this.pos.x-2)+'px',top:(this.pos.y-2)+'px'});},togglePopup:function(){this.popup.toggle();}});var EventTimeline=Class.create(UIElement,{initialize:function(controller,container){this.controller=controller;this.container=container;this.resizeTimerID=null;this.eventSource=new Timeline.DefaultEventSource();var bandInfos=[Timeline.createBandInfo({eventSource:this.eventSource,width:"70%",intervalUnit:Timeline.DateTime.MONTH,intervalPixels:100}),Timeline.createBandInfo({eventSource:this.eventSource,width:"30%",intervalUnit:Timeline.DateTime.YEAR,intervalPixels:200})],self=this;bandInfos[1].syncWith=0;bandInfos[1].highlight=true;this.timeline=Timeline.create($(this.container),bandInfos);this.timeline.loadJSON("http://localhost/dev/test.json",function(json,url){self.eventSource.loadJSON(json,url);});},resize:function(){if(this.resizeTimerID===null){this.resizeTimerID=window.setTimeout(function(){this.resizeTimerID=null;this.timeline.layout();},500);}}});var Helioviewer=Class.create({initialize:function(viewportId,api,view,defaults){Object.extend(this,defaults);this.load=view;this.api=api;this.viewportId=viewportId;this.loadingIndicator=new LoadingIndicator();this.loadUserSettings();this.date=new Date(this.userSettings.get('obs-date'));$('date').writeAttribute('value',this.date.toYmdUTCString());$('time').writeAttribute('value',this.date.toHmUTCString());this.layerManager=new LayerManager(this);this._initViewport();this._initUI();this._initEvents();this._initKeyBoardListeners();this.userSettings.get('tile-layers').each((function(settings){this.layerManager.addLayer(new TileLayer(this.viewport,settings));}).bind(this));},_initUI:function(){var centerBtn,outsideBox,mouseCoords;this.calendar=new Calendar(this,'date','time');this.zoomControl=new ZoomControl(this,{id:'zoomControl',zoomLevel:this.userSettings.get('zoom-level'),minZoomLevel:this.minZoomLevel,maxZoomLevel:this.maxZoomLevel});this.timeControls=new TimeControls(this,'timestep-select','timeBackBtn','timeForwardBtn',this.timeIncrementSecs);this.messageConsole=new MessageConsole(this,'message-console','helioviewer-viewport-container-outer');this.tileLayerAccordion=new TileLayerAccordion(this.layerManager,'tileLayerAccordion');this.eventLayerAccordion=new EventLayerAccordion(this.viewport,'eventAccordion');this._initToolTips();this._createFullscreenBtn();mouseCoords=Builder.node('div',{id:'mouse-coords',style:'display: none'});Element.extend(mouseCoords);mouseCoords.insert(Builder.node('div',{id:'mouse-coords-x',style:'width:50%; float: left'}));mouseCoords.insert(Builder.node('div',{id:'mouse-coords-y',style:'width:50%; float: left'}));this.viewport.innerNode.insert(mouseCoords);this._setupDialogs();},_setupDialogs:function(){jQuery("#helioviewer-about").click(function(){if(jQuery(this).hasClass("dialog-loaded")){var d=jQuery('#about-dialog');if(d.dialog('isOpen')){d.dialog('close');}
else{d.dialog('open');}}else{jQuery('#about-dialog').load(this.href).dialog({autoOpen:true,title:"Helioviewer - About",width:480,height:300,draggable:true});jQuery(this).addClass("dialog-loaded");}
return false;});jQuery("#helioviewer-usage").click(function(){if(jQuery(this).hasClass("dialog-loaded")){var d=jQuery('#usage-dialog');if(d.dialog('isOpen')){d.dialog('close');}
else{d.dialog('open');}}else{jQuery('#usage-dialog').load(this.href).dialog({autoOpen:true,title:"Helioviewer - Usage Tips",width:480,height:480,draggable:true});jQuery(this).addClass("dialog-loaded");}
return false;});},loadUserSettings:function(){this.userSettings=new UserSettings(this);if(this.load["obs-date"]){this.userSettings.set('obs-date',parseInt(this.load["obs-date"],10)*1000);}
if(this.load["img-scale"]){this.userSettings.set('zoom-level',this.scaleToZoomLevel(parseInt(this.load["img-scale"],10)));}
if(this.load.layers){var layers=[];$A(this.load.layers).each(function(layer){layers.push({tileAPI:"api/index.php",observatory:layer.substr(0,3),instrument:layer.substr(3,3),detector:layer.substr(6,3),measurement:layer.substr(9,3)});});this.userSettings.set('tile-layers',layers);}},_createFullscreenBtn:function(){var btn,footer,vp,sb,speed,marginSize,origOutsideMarginLeft,origOutsideMarginRight,origHeaderHeight,origViewportHeight,$_fx_step_default,self;btn=jQuery("#fullscreen-btn");outsideBox=jQuery('#outsideBox');vp=jQuery('#helioviewer-viewport-container-outer');sb=jQuery('#sandbox');footer=jQuery('#footer-links-container-outer');header=jQuery('#middle-col-header');panels=jQuery("#left-col, #right-col, #footer-links-container-outer");speed=500;marginSize=5;self=this;var $_fx_step_default=jQuery.fx.step._default;jQuery.fx.step._default=function(fx){if(!(fx.elem.id==="sandbox")){return $_fx_step_default(fx);}
self.viewport.updateSandbox();fx.elem.updated=true;};btn.click(function(){outsideBox.toggleClass('fullscreen-mode');if(outsideBox.hasClass('fullscreen-mode')){origOutsideMarginLeft=outsideBox.css("margin-left");origOutsideMarginRight=outsideBox.css("margin-right");origHeaderHeight=header.height();origViewportHeight=vp.height();outsideBox.animate({marginLeft:marginSize,marginRight:marginSize},speed,function(){self.viewport.checkTiles();self.layerManager.resetLayers(self.viewport.visible);panels.hide();});header.animate({height:marginSize},speed);vp.animate({height:jQuery(window).height()-(marginSize*3)},speed);sb.animate({right:1},speed);}else{panels.show();outsideBox.animate({marginLeft:origOutsideMarginLeft,marginRight:origOutsideMarginRight},speed);vp.animate({height:origViewportHeight},speed);header.animate({height:origHeaderHeight},speed);sb.animate({right:0},speed);}})},_initViewport:function(){this.viewport=new Viewport(this,{id:this.viewportId,zoomLevel:this.userSettings.get('zoom-level'),prefetch:this.prefetchSize,debug:false});Event.observe(window,'resize',this.viewport.resize.bind(this.viewport));},_initEvents:function(){var self=this;this.observe(this.zoomControl,'change',this.handlers.zoom);this.observe(this.calendar,'observationDateChange',this.handlers.observationDateChange);this.observe(this.layerManager,'newLayer',this.handlers.newLayer);Event.observe(this.calendar.timeField,'change',this.handlers.observationTimeChange.bindAsEventListener(this));jQuery('#center-button').click(function(){self.viewport.center.call(self.viewport)});},_initKeyBoardListeners:function(){var self=this;Event.observe(document,'keypress',function(e){if(e.target.tagName!=="INPUT"){var code,character;if(!e){e=window.event;}
if(e.keyCode){code=e.keyCode;}
else if(e.which){code=e.which;}
character=String.fromCharCode(code);if(character==="-"||character==="_"){self.zoomControl.zoomButtonClicked(+1);}
else if(character==="="||character==="+"){self.zoomControl.zoomButtonClicked(-1);}
else if(character==="c"){self.viewport.center();}
else if(character==="d"){self.layerManager.toggleLabels();}
else if(character==="m"){self.viewport.ViewportHandlers.toggleMouseCoords();}
else if(character==="f"){jQuery("#fullscreen-btn").click();}
else if(character===","){self.timeControls.timePrevious();}
else if(character==="."){self.timeControls.timeNext();}}});},_initToolTips:function(){var items=$A(['#zoomControlZoomIn','#zoomControlZoomOut','#zoomControlHandle','#timeBackBtn','#timeForwardBtn']),self=this;items.each(function(item){self.addToolTip(item,{yOffset:-125});});this.addToolTip('#movieBuilder',{position:'topleft'});},addToolTip:function(id,params){var options=params||[],classname="tooltip-"+(options.position||"bottomleft")+"-"+(options.tooltipSize||"medium");jQuery(id).tooltip({delay:(options.delay?options.delay:1000),track:(options.track?options.track:false),showURL:false,opacity:1,fixPNG:true,showBody:" - ",extraClass:classname,top:(options.yOffset?options.yOffset:0),left:12});},observe:function(uielement,eventName,eventHandler){uielement.addObserver(eventName,eventHandler.bind(this));},setDate:function(date){this.date=date;var ts=Date.UTC(date.getUTCFullYear(),date.getUTCMonth(),date.getUTCDate(),date.getUTCHours(),date.getUTCMinutes(),date.getUTCSeconds());this.userSettings.set('obs-date',parseInt(ts,10));this.layerManager.reloadLayers();},scaleToZoomLevel:function(imgScale){var zoomOffset=Math.round(Math.lg((imgScale/this.baseScale)));return this.baseZoom+zoomOffset;},handlers:{zoom:function(level){this.viewport.zoomTo(level);},observationDateChange:function(date){this.setDate(date);this.calendar.updateFields();},observationTimeChange:function(e){var time=e.target.value,regex,newTime,hours,mins,secs;regex=/^\d{2}:\d{2}:\d{2}?/;if(time.match(regex)){newTime=time.split(':');hours=parseInt(newTime[0],10)-this.date.getUTCHours();mins=parseInt(newTime[1],10)-this.date.getUTCMinutes();secs=parseInt(newTime[2],10)-this.date.getUTCSeconds();this.date.addHours(hours);this.date.addMinutes(mins);this.date.setSeconds(secs);this.setDate(this.date);}else{this.messageConsole.warn('Invalid time. Please enter a time in of form HH:MM:SS');}},newToolTip:function(tooltip){this.addToolTip(tooltip.id,tooltip.params);},newLayer:function(data){var inst=data.instrument,ui=data.menuEntry,layer;layer=new TileLayer(this.viewport,{tileAPI:this.api,observatory:inst.observatory,instrument:inst.instrument,detector:inst.detector,measurement:inst.measurement});this.viewport.addLayer(layer);ui.layer=layer;ui.displayTileLayerOptions();}}});String.prototype.padLeft=function(padding,minLength){var str=this,pad=''+padding;while(str.length<minLength){str=pad+str;}
return str;};String.prototype.trimLeft=function(padding){var str=this,pad=''+padding;while(str[0]===pad){str=str.substr(1);}
return str;};Date.prototype.toYmdUTCString=function(){var year=this.getUTCFullYear()+'',month=(this.getUTCMonth()+1)+'',day=this.getUTCDate()+'';return year+'/'+month.padLeft(0,2)+'/'+day.padLeft(0,2);};Date.prototype.toHmUTCString=function(){var hour=this.getUTCHours()+'',min=this.getUTCMinutes()+'',sec=this.getUTCSeconds()+'';return hour.padLeft(0,2)+':'+min.padLeft(0,2)+':'+sec.padLeft(0,2);};Date.prototype.toUTCDate=function(){var utcOffset=this.getUTCOffset(),sign=utcOffset[0],hours=parseInt(utcOffset.substr(1,2),10),mins=parseInt(utcOffset.substr(3,4),10),numSecs=(3600*hours)+(60*mins);if(sign==="+"){numSecs=-numSecs;}
this.addSeconds(numSecs);};Element.addMethods({observeOnce:(Event.observeOnce=function(element,eventName,handler){return Event.observe(element,eventName,function(e){Event.stopObserving(element,eventName,arguments.callee);handler.call(element,e);});})});var getOS=function(){var os="other";if(navigator.appVersion.indexOf("Win")!==-1){os="win";}
if(navigator.appVersion.indexOf("Mac")!==-1){os="mac";}
if(navigator.appVersion.indexOf("X11")!==-1){os="linux";}
if(navigator.appVersion.indexOf("Linux")!==-1){os="linux";}
return os;};Math.toPolarCoords=function(x,y){var radians=Math.atan(y/x);if((x>0)&&(y<0)){radians+=(2*Math.PI);}
else if(x<0){radians+=Math.PI;}
else if((x===0)&&(y>0)){radians=Math.PI/2;}
else if((x===0)&&(y<0)){radians=(3*Math.PI)/2;}
return{r:Math.sqrt(Math.pow(x,2)+Math.pow(y,2)),theta:(180/Math.PI)*radians};};Math.lg=function(x){return(Math.log(x)/Math.log(2));};var IconPicker=Class.create({initialize:function(id){this.id=id;this.AVAILABLE_ICON_SHAPES=$A(["circle","square","diamond"]);this.AVAILABLE_ICON_COLORS=$A(["red","orange","green","yellow","blue","lightblue"]);this.focus=null;this.loaded=false;},_buildIconList:function(){var i,closeBtn,menu,self=this;menu=jQuery("<div id='"+this.id+"' class='ui-widget ui-widget-content ui-corner-all' style='display: none;'></div>");menu.append(jQuery('<div id=event-icon-menu-title><span style="vertical-align: middle">Chose an icon:</span></div><div id="event-icon-menu-body">'));i=1;this.AVAILABLE_ICON_COLORS.each(function(color){self.AVAILABLE_ICON_SHAPES.each(function(shape){var icon=jQuery('<img class="event-icon-menu-icon" src="images/events/small-'+color+"-"+shape+'.png" alt="'+color+'-'+shape+'">');icon.click(function(){self.focus.updateIcon(this.alt);jQuery('#event-icon-menu').fadeOut();});menu.append(icon);if(i%3===0){menu.append(jQuery("<br>"));}
i+=1;});});closeBtn=jQuery('<br><div style="text-align: right"><a class="light" href="#" style="margin-right: 2px;">[Close]</a></div>').click(function(){jQuery('#event-icon-menu').fadeOut();});menu.append(closeBtn);menu.append("</div>");jQuery('body').append(menu);},toggle:function(layer,pos){if(!this.loaded){this._buildIconList();this.loaded=true;}
this.focus=layer;jQuery('#'+this.id).css({'left':pos.left+16,'top':pos.top+16}).slideToggle();}});var LayerManager=Class.create(UIElement,{initialize:function(controller){this.controller=controller;this.layers=$A([]);this.labels=false;},addLayer:function(layer){this.layers.push(layer);},addNewLayer:function(){var priorityQueue,currentLayers,p,defaultChoice="SOHEITEIT171";priorityQueue=$A(["SOHEITEIT304","SOHLAS0C20WL","SOHLAS0C30WL","SOHLAS0C20WL","SOHMDIMDImag","SOHMDIMDIint","SOHEITEIT171","SOHEITEIT284","SOHEITEIT195"]);currentLayers=$A([]);this.tileLayers().each(function(l){currentLayers.push(l.observatory+l.instrument+l.detector+l.measurement);});currentLayers.each(function(id){priorityQueue=priorityQueue.without(id);});p=priorityQueue.first()||defaultLayer;this.addLayer(new TileLayer(this.controller.viewport,{tileAPI:this.controller.api,observatory:p.substr(0,3),instrument:p.substr(3,3),detector:p.substr(6,3),measurement:p.substr(9,3),startOpened:true}));this.refreshSavedTileLayers();},numTileLayers:function(){var n=0;this.layers.each(function(l){if(l.type==="TileLayer"){n+=1;}});return n;},getMaxDimensions:function(){var maxWidth=0,maxHeight=0;this.layers.each(function(l){if(l.type==="TileLayer"){if(Object.isNumber(l.relWidth)){maxWidth=Math.max(maxWidth,l.relWidth);maxHeight=Math.max(maxHeight,l.relHeight);}}});return{width:maxWidth,height:maxHeight};},hasEventCatalog:function(catalog){return(this.eventLayers().find(function(l){return l.catalog===catalog;})?true:false);},eventLayers:function(){return this.layers.findAll(function(l){return l.type==="EventLayer";});},tileLayers:function(){return this.layers.findAll(function(l){return l.type==="TileLayer";});},numEventLayers:function(){var n=0;this.layers.each(function(l){if(l.type==="EventLayer"){n+=1;}});return n;},removeLayer:function(layer){layer.domNode.remove();this.layers=this.layers.without(layer);},reloadLayers:function(){this.layers.each(function(layer){layer.reload();});},getLabelVisibility:function(){if(this.labels===true){return"inline";}
else{return"none";}},toggleLabels:function(){this.labels=!this.labels;jQuery('.event-label').toggle();},resetLayers:function(visible){this.layers.each(function(layer){layer.reset(visible);});},refreshSavedTileLayers:function(){var tilelayers=[];this.tileLayers().each(function(layer){var settings={tileAPI:layer.tileAPI,observatory:layer.observatory,instrument:layer.instrument,detector:layer.detector,measurement:layer.measurement};tilelayers.push(settings);});this.controller.userSettings.set('tile-layers',tilelayers);}});var MessageConsole=Class.create(UIElement,{initialize:function(controller,container,viewport){this.controller=controller;this.console=$(container);this.viewportId=viewport;},log:function(msg){this.console.update(new Element('p',{style:'color: #6495ED; font-weight: bold;'}).insert(msg));var self=this,trash=new Effect.Appear(this.console,{duration:3.0});window.setTimeout(function(){var trash=new Effect.Fade(self.console,{duration:3.0});},6500);},warn:function(msg){this.console.update(new Element('p',{style:'color: yellow; font-weight: bolder;'}).insert(msg));var self=this,trash=new Effect.Appear(this.console,{duration:3.0});window.setTimeout(function(){var trash=new Effect.Fade(self.console,{duration:3.0});},6500);},error:function(msg){this.console.update(new Element('p',{style:'color: red'}).insert(msg));var self=this,trash=new Effect.Shake(this.viewportId,{distance:15,duration:0.1});trash=new Effect.Appear(this.console,{duration:3.0});window.setTimeout(function(){var trash=new Effect.Fade(self.console,{duration:3.0});},6500);},link:function(msg,linkText){var self=this,linkId,wrapper,link,trash;linkId='link-'+this.controller.date.getTime()/1000;wrapper=new Element('span');link=new Element('a',{href:'#',id:linkId,'class':'message-console-link'}).update(linkText);wrapper.insert(msg);wrapper.insert(link);this.console.update(new Element('p',{style:'color: #6495ED;'}).insert(wrapper));trash=new Effect.Appear(this.console,{duration:2.0});Event.observe(linkId,'click',function(){self.console.hide();});return linkId;}});var MovieBuilder=Class.create(UIElement,{defaultOptions:{active:false,url:"api/index.php",minZoomLevel:13,numFrames:40,frameRate:8,sharpen:false,edgeEnhance:false,format:{win:"asf",mac:"mov",linux:"mp4"}},initialize:function(options){Object.extend(this,this.defaultOptions);Object.extend(this,options);var self=this;Event.observe(this.id,'click',function(){if(!self.active){var hv=self.controller,hqFormat,displayRange,xhr;self.active=true;hqFormat=self.format[getOS()];displayRange=hv.viewport.displayRange();xhr=new Ajax.Request(self.url,{method:'POST',parameters:{action:"buildQuickMovie",layers:"SOHEITEIT304,SOHLAS0C20WL",startDate:hv.date.getTime()/1000,zoomLevel:hv.viewport.zoomLevel,numFrames:self.numFrames,frameRate:self.frameRate,edges:self.edgeEnhance,sharpen:self.sharpen,format:hqFormat,xRange:displayRange.xStart+", "+displayRange.xEnd,yRange:displayRange.yStart+", "+displayRange.yEnd},onComplete:function(transport){var linkId=self.controller.messageConsole.link('','Quick-Video ready! Click here to start watching.');self.active=false;Event.observe(linkId,'click',function(){Shadowbox.open({player:'iframe',title:'Helioviewer Movie Player',height:650,width:550,content:self.url+'?action=playMovie&format='+hqFormat+'&url='+transport.responseJSON});});}});}});}});var TileLayer=Class.create(Layer,{defaultOptions:{type:'TileLayer',rootDir:'tiles/',cacheEnabled:true,opacity:100,autoOpacity:true,startOpened:false,sharpen:false},initialize:function(viewport,options){Object.extend(this,this.defaultOptions);Object.extend(this,options);this.viewport=viewport;this.tileSize=viewport.tileSize;this.layerManager=viewport.controller.layerManager;this.id='tilelayer'+new Date().getTime();this.domNode=new Element('div',{className:'tile-layer-container',style:'position: absolute;'});viewport.movingContainer.appendChild(this.domNode);this.viewport.addObserver('move',this.viewportMove.bind(this));this.tiles=[];this.loadClosestImage();},reload:function(){this.loadClosestImage();},removeTiles:function(){this.tiles=[];},reset:function(visible){var i,j,currentScale,scaleOffset,old,numTiles,numTilesLoaded,indices,tile,onLoadComplete,self=this;this.viewport.controller.loadingIndicator.loadingStarted();currentScale=this.viewport.controller.baseScale*Math.pow(2,this.viewport.zoomLevel-this.viewport.controller.baseZoom);scaleOffset=this.naturalImageScale/currentScale;this.relWidth=this.width*scaleOffset;this.relHeight=this.height*scaleOffset;if((this.viewport.zoomLevel<this.minZoom)&&(this.viewport.controller.userSettings.get('warn-zoom-level')==="false")){this.viewport.controller.messageConsole.log("Note: "+this.name+" is not available at this resolution. Images will be artificially enlarged.");this.viewport.controller.userSettings.set('warn-zoom-level',true);}
this.removeTiles();this.refreshUTCDate();old=[];this.domNode.childElements().each(function(tile){old.push(tile);});numTiles=0;numTilesLoaded=0;indices=this.viewport.visibleRange;onLoadComplete=function(e){numTilesLoaded+=1;if(numTilesLoaded===numTiles){old.each(function(tile){if(tile.parentNode){tile.remove();}});self.viewport.controller.loadingIndicator.loadingFinished();}};for(i=indices.xStart;i<=indices.xEnd;i+=1){for(j=indices.yStart;j<=indices.yEnd;j+=1){if(visible[i][j]){tile=$(this.domNode.appendChild(this.getTile(i,j,this.viewport.zoomLevel)));if(!this.tiles[i]){this.tiles[i]=[];}
this.tiles[i][j]={};this.tiles[i][j].img=tile;numTiles+=1;Event.observe(this.tiles[i][j].img,'load',onLoadComplete);}}}},refreshUTCDate:function(){var date=new Date(this.timestamp*1000);date.toUTCDate();this.utcDate=date;},setImageProperties:function(imageProperties){if(imageProperties.imageId===this.imageId){this.fire('obs_time_change',this);return;}
Object.extend(this,imageProperties);this.fire('obs_time_change',this);this.setZIndex(parseInt(this.opacityGroupId,10)-10);if(this.autoOpacity){this.setInitialOpacity();this.autoOpacity=false;}
this.fire('change',this);this.viewport.checkTiles(true);this.reset(this.viewport.visible);},setImage:function(imageId){if(imageId===this.imageId){return;}
this.imageId=imageId;this.loadImageProperties();this.reset(this.viewport.visible);},setInitialOpacity:function(){var self=this,opacity=1,counter=0;this.layerManager.layers.each(function(layer){if(parseInt(layer.opacityGroupId,10)===parseInt(self.opacityGroupId,10)){counter+=1;}});if(counter>1){opacity=opacity/counter;this.domNode.setOpacity(opacity);this.opacity=opacity*100;}},setOpacity:function(opacity){this.opacity=opacity;opacity=opacity/100;this.domNode.setOpacity(opacity);},loadClosestImage:function(){var date=this.viewport.controller.date,processResponse,xhr;processResponse=function(transport){this.setImageProperties(transport.responseJSON);var hv=this.viewport.controller;this.viewport.updateSandbox();if(!hv.tileLayerAccordion.hasId(this.id)){hv.tileLayerAccordion.addLayer(this);}
else{hv.tileLayerAccordion.updateTimeStamp(this);hv.tileLayerAccordion.updateLayerDesc(this.id,this.name);hv.tileLayerAccordion.updateOpacitySlider(this.id,this.opacity);}};xhr=new Ajax.Request(this.viewport.controller.api,{method:'POST',parameters:{action:'getClosestImage',observatory:this.observatory,instrument:this.instrument,detector:this.detector,measurement:this.measurement,timestamp:date.getTime()/1000},onSuccess:processResponse.bind(this)});},toggleSharpening:function(){if(this.sharpen===true){}else{}
this.sharpen=!this.sharpen;},viewportMove:function(position){var visible=this.viewport.visible,indices=this.viewport.visibleRange,i,j;for(i=indices.xStart;i<=indices.xEnd;i+=1){for(j=indices.yStart;j<=indices.yEnd;j+=1){if(!this.tiles[i]){this.tiles[i]=[];}
if(visible[i][j]&&(!this.tiles[i][j])){this.tiles[i][j]=$(this.domNode.appendChild(this.getTile(i,j,this.viewport.zoomLevel)));}}}},getTile:function(x,y){var left=x*this.tileSize,top=y*this.tileSize,zoom=this.viewport.zoomLevel,ts=this.tileSize,self=this,rf=function(){return false;},img,altId,xhr,processResponse;img=$(new Image());img.addClassName('tile');img.setStyle({left:left+'px',top:top+'px'});img.unselectable='on';img.onmousedown=rf;img.ondrag=rf;img.onmouseover=rf;img.oncontextmenu=rf;img.galleryimg='no';img.alt="";Event.observe(img,'error',function(e){Event.stopObserving(img,'error');if(self.viewport.controller.backupEnabled){processResponse=function(transport){Event.observe(this,'error',function(){this.src='images/transparent_'+ts+'.gif';});altId=transport.responseJSON.id;this.src=self.viewport.controller.backupAPI+'?action=getTile&x='+x+'&y='+y+'&zoom='+zoom+'&imageId='+altId+'&ts='+ts;};xhr=new Ajax.Request(self.tileAPI,{method:'POST',parameters:{action:'getJP2Id',server:'backup',observatory:self.observatory,instrument:self.instrument,detector:self.detector,measurement:self.measurement,timestamp:self.viewport.controller.date.getTime()/1000},onSuccess:processResponse.bind(this)});}else{this.src='images/transparent_'+ts+'.gif';}});img.src=this.tileAPI+'?action=getTile&x='+x+'&y='+y+'&zoom='+zoom+'&imageId='+this.imageId+'&ts='+ts;return img;}});var TileLayerAccordion=Class.create(Layer,{initialize:function(layerManager,containerId){this.layerManager=layerManager;this.container=jQuery('#'+containerId);this.queryURL="api/index.php";this.options={};this._setupUI();this.domNode=jQuery('#TileLayerAccordion-Container');this.domNode.dynaccordion({startClosed:true});this.layerSettings=new Hash();},addLayer:function(layer){var processResponse=function(transport){var visibilityBtn,removeBtn,head,body,slider;visibilityBtn="<span class='layerManagerBtn visible' id='visibilityBtn-"+layer.id+"' title='toggle layer visibility'></span>";removeBtn="<span class='ui-icon ui-icon-closethick removeBtn' id='removeBtn-"+layer.id+"' title='remove layer'></span>";head="<div class='layer-Head ui-accordion-header ui-helper-reset ui-state-default ui-corner-all'><span class=tile-accordion-header-left>"+layer.name+"</span><span class=tile-accordion-header-right><span class=timestamp></span><span class=accordion-header-divider>|</span>"+visibilityBtn+removeBtn+"</span></div>";this.options.observatories=transport.responseJSON.observatories;this.options.instruments=transport.responseJSON.instruments;this.options.detectors=transport.responseJSON.detectors;this.options.measurements=transport.responseJSON.measurements;body=this._buildEntryBody(layer);this.domNode.dynaccordion("addSection",{id:layer.id,header:head,cell:body,open:layer.startOpened});slider=new Control.Slider("opacity-slider-handle-"+layer.id,"opacity-slider-track-"+layer.id,{sliderValue:layer.opacity,range:$R(1,100),values:$R(1,100),onSlide:function(v){layer.setOpacity(v);}});this.layerSettings.set(layer.id,{header:head,body:body,opacitySlider:slider});this._setupEventHandlers(layer);this.updateTimeStamp(layer);},xhr=new Ajax.Request(this.queryURL,{method:'POST',onSuccess:processResponse.bind(this),parameters:{action:"getLayerAvailability",observatory:layer.observatory,instrument:layer.instrument,detector:layer.detector,measurement:layer.measurement,format:"json"}});},hasId:function(id){return(this.layerSettings.keys().grep(id).length>0?true:false);},_buildEntryBody:function(layer){var id,options,opacitySlide,obs,inst,det,meas,fits;id=layer.id;options=this.options;opacitySlide="<div class='layer-select-label'>Opacity: </div>";opacitySlide+="<div class='opacity-slider-track' id='opacity-slider-track-"+id+"' style='width:120px; height:10px;'>";opacitySlide+="<div class='opacity-slider-handle' id='opacity-slider-handle-"+id+"' style='10px; 19px;'></div>";opacitySlide+="</div>";obs="<div class=layer-select-label>Observatory: </div> ";obs+="<select name=observatory class=layer-select id='observatory-select-"+id+"'>";jQuery.each(options.observatories,function(i,o){obs+="<option value='"+o.abbreviation+"'";if(layer.observatory===o.abbreviation){obs+=" selected='selected'";}
obs+=">"+o.name+"</option>";});obs+="</select><br>";inst="<div class=layer-select-label>Instrument: </div> ";inst+="<select name=instrument class=layer-select id='instrument-select-"+id+"'>";jQuery.each(options.instruments,function(i,o){inst+="<option value='"+o.abbreviation+"'";if(layer.instrument===o.abbreviation){inst+=" selected='selected'";}
inst+=">"+o.name+"</option>";});inst+="</select><br>";det="<div class=layer-select-label>Detector: </div> ";det+="<select name=detector class=layer-select id='detector-select-"+id+"'>";jQuery.each(options.detectors,function(i,o){det+="<option value='"+o.abbreviation+"'";if(layer.detector===o.abbreviation){det+=" selected='selected'";}
det+=">"+(o.name===""?o.abbreviation:o.name)+"</option>";});det+="</select><br>";meas="<div class=layer-select-label>Measurement: </div> ";meas+="<select name=measurement class=layer-select id='measurement-select-"+id+"'>";jQuery.each(options.measurements,function(i,o){meas+="<option value='"+o.abbreviation+"'";if(layer.measurement===o.abbreviation){meas+=" selected='selected'";}
meas+=">"+o.name+"</option>";});meas+="</select><br><br>";fits="<a href='#' id='showFITSBtn-"+id+"' style='margin-left:170px; color: white; text-decoration: none;'>FITS Header</a><br>";return(opacitySlide+obs+inst+det+meas+fits);},updateOpacitySlider:function(id,opacity){this.layerSettings.get(id).opacitySlider.setValue(opacity);},_setupUI:function(){var title,addLayerBtn,hv,self=this;title=jQuery('<span class="section-header">Overlays</span>').css({'float':'left'});addLayerBtn=jQuery('<a href=# class=dark>[Add]</a>').css({'margin-right':'14px'});this.container.append(jQuery('<div></div>').css('text-align','right').append(title).append(addLayerBtn));this.container.append(jQuery('<div id="TileLayerAccordion-Container"></div>'));hv=this.layerManager.controller;addLayerBtn.click(function(){self.layerManager.addNewLayer();});},_setupEventHandlers:function(layer){var toggleVisibility,removeLayer,showFITS,visible,icon,accordion,self=this,visibilityBtn=jQuery("#visibilityBtn-"+layer.id),removeBtn=jQuery("#removeBtn-"+layer.id),fitsBtn=jQuery("#showFITSBtn-"+layer.id);toggleVisibility=function(e){visible=layer.toggleVisible();$("visibilityBtn-"+layer.id).toggleClassName('hidden');e.stopPropagation();};removeLayer=function(e){accordion=e.data;accordion.layerManager.removeLayer(layer);accordion.domNode.dynaccordion('removeSection',{id:layer.id});accordion.layerSettings.unset(layer.id);accordion.layerManager.refreshSavedTileLayers();e.stopPropagation();};jQuery.each(jQuery('#'+layer.id+' > div > select'),function(i,item){jQuery(item).change(function(e){if(this.name==="observatory"){layer.observatory=this.value;}
else if(this.name==="instrument"){layer.instrument=this.value;}
else if(this.name==="detector"){layer.detector=this.value;}
else if(this.name==="measurement"){layer.measurement=this.value;}
self._onLayerSelectChange(layer,this.name,this.value);});});fitsBtn.bind('click',this,this._showFITS.bindAsEventListener(this,layer));visibilityBtn.bind('click',this,toggleVisibility);removeBtn.bind('click',this,removeLayer);},_showFITS:function(event,layer){var dialogId,response,sortBtn,formatted,processResponse,xhr;dialogId="fits-header-"+layer.id;if(jQuery("#"+dialogId).length===0){processResponse=function(transport){response=transport.responseJSON;formatted="<div id='"+dialogId+"' style='overflow: auto; position: relative; padding:0px'>";formatted+="<div class='fits-regular'>";$A(response).each(function(line){formatted+=line+"<br>";});formatted+="</div>"
formatted+="<div class='fits-sorted' style='display: none;'>";$A(response.sort()).each(function(line){formatted+=line+"<br>";});formatted+="</div></div>";jQuery("body").append(formatted);sortBtn="<span class='fits-sort-btn'>Abc</span>";jQuery("#"+dialogId).append(sortBtn);jQuery("#"+dialogId+" > span").click(function(){jQuery(this).toggleClass("italic");jQuery("#"+dialogId+" .fits-sorted").toggle();jQuery("#"+dialogId+" .fits-regular").toggle();});jQuery("#"+dialogId).dialog({autoOpen:true,title:"FITS Header: "+layer.name,width:400,height:350,draggable:true});};xhr=new Ajax.Request("api/index.php",{method:'POST',onSuccess:processResponse.bind(this),parameters:{action:"getJP2Header",imageId:layer.imageId}});}else{if(!jQuery("#"+dialogId).dialog("isOpen")){jQuery("#"+dialogId).dialog("open");}else{jQuery("#"+dialogId).dialog("close");}}},_onLayerSelectChange:function(layer,changed,value){var obs,inst,det,meas,xhr,processResponse;processResponse=function(transport){this.options=transport.responseJSON;if(changed==="observatory"){this._updateOptions(layer.id,"instrument",this.options.instruments);if($A(this.options.instruments).grep(layer.instrument).length===0){layer.instrument=this.options.instruments[0];}}
if((changed==="observatory")||(changed==="instrument")){this._updateOptions(layer.id,"detector",this.options.detectors);if(!$A(this.options.detectors).find(function(det){return det.abbreviation===layer.detector;})){layer.detector=this.options.detectors[0].abbreviation;}}
if((changed==="observatory")||(changed==="instrument")||(changed==="detector")){this._updateOptions(layer.id,"measurement",this.options.measurements);if(!$A(this.options.measurements).find(function(meas){return meas.abbreviation===layer.measurement;})){layer.measurement=this.options.measurements[0].abbreviation;}}
layer.reload();this.layerManager.refreshSavedTileLayers();};if(changed!=="measurement"){obs=(changed==="observatory"?value:layer.observatory);inst=(changed==="instrument"?value:layer.instrument);det=(changed==="detector"?value:layer.detector);meas=(changed==="measurement"?value:layer.measurement);xhr=new Ajax.Request(this.queryURL,{method:'POST',onSuccess:processResponse.bind(this),parameters:{action:"getLayerAvailability",observatory:obs,instrument:inst,detector:det,measurement:meas,format:"json",changed:changed,value:value}});}
else{layer.reload();this.layerManager.refreshSavedTileLayers();}},_updateOptions:function(id,field,newOptions){var select,opt;$$('#'+field+'-select-'+id+' > option').each(function(o){o.remove();});select=$(field+'-select-'+id);$A(newOptions).each(function(o){opt=new Element('option',{value:o.abbreviation}).insert(o.name===""?o.abbreviation:o.name);select.insert(opt);});},updateTimeStamp:function(layer){var domNode,date,dateString,timeDiff,ts;domNode=$(layer.id).select('.timestamp').first();domNode.removeClassName("timeBehind");domNode.removeClassName("timeAhead");domNode.removeClassName("timeSignificantlyOff");date=new Date(layer.timestamp*1000);dateString=date.toYmdUTCString()+' '+date.toHmUTCString();timeDiff=layer.timestamp-this.layerManager.controller.date.getTime()/1000;domNode.update(dateString);ts=this.layerManager.controller.timeIncrementSecs;if(timeDiff<0){if(Math.abs(timeDiff)>(4*ts)){domNode.addClassName("timeSignificantlyOff");}
else{domNode.addClassName("timeBehind");}}
else if(timeDiff>0){if(timeDiff>(4*ts)){domNode.addClassName("timeSignificantlyOff");}
else{domNode.addClassName("timeAhead");}}},updateLayerDesc:function(id,desc){$(id).select("span.tile-accordion-header-left").first().update(desc);}});var TimeControls=Class.create(UIElement,{initialize:function(controller,incrementSelect,backBtn,forwardBtn,timeIncrement){this.controller=controller;this.className="TimeControls";this._timeIncrement=timeIncrement;this._addTimeIncrements(incrementSelect);Event.observe(backBtn,'click',this.timePrevious.bind(this));Event.observe(forwardBtn,'click',this.timeNext.bind(this));},_addTimeIncrements:function(selectId){var timeSteps,select,opt;timeSteps=[{numSecs:1,txt:"1&nbsp;Sec"},{numSecs:60,txt:"1&nbsp;Min"},{numSecs:300,txt:"5&nbsp;Mins"},{numSecs:900,txt:"15&nbsp;Mins"},{numSecs:3600,txt:"1&nbsp;Hour"},{numSecs:21600,txt:"6&nbsp;Hours"},{numSecs:43200,txt:"12&nbsp;Hours"},{numSecs:86400,txt:"1&nbsp;Day"},{numSecs:604800,txt:"1&nbsp;Week"},{numSecs:2419200,txt:"28&nbsp;Days"},{numSecs:31556926,txt:"1&nbsp;Year"}];select=$(selectId);$A(timeSteps).each(function(o){opt=new Element('option',{value:o.numSecs}).insert(o.txt);select.insert(opt);});select.select('option[value='+this._timeIncrement+']')[0].writeAttribute('selected','selected');Event.observe(select,'change',this._onChange.bindAsEventListener(this));},_onChange:function(e){this._timeIncrement=parseInt(e.target.value,10);this.fire('timeIncrementChange',this._timeIncrement);},timePrevious:function(){var newDate=this.controller.date.addSeconds(-this._timeIncrement);this.controller.setDate(newDate);this.controller.calendar.updateFields();},timeNext:function(){var newDate=this.controller.date.addSeconds(this._timeIncrement);this.controller.setDate(newDate);this.controller.calendar.updateFields();}});var UserSettings=Class.create({initialize:function(controller){this.controller=controller;this._DEFAULTS=$H({'obs-date':1065312000000,'zoom-level':this.controller.defaultZoomLevel,'tile-layers':[{tileAPI:"api/index.php",observatory:'SOH',instrument:'EIT',detector:'EIT',measurement:'304'}],'warn-zoom-level':false,'warn-mouse-coords':false,'event-icons':{'VSOService::noaa':'small-blue-circle','GOESXRayService::GOESXRay':'small-green-diamond','VSOService::cmelist':'small-yellow-square'}});this._INTEGER_PARAMS=$A(['obs-date','zoom-level']);this._FLOAT_PARAMS=$A([]);this._BOOLEAN_PARAMS=$A(['warn-zoom-level','warn-mouse-coords']);this.cookies=new CookieJar({expires:31536000,path:'/'});if(!this._exists()){this._loadDefaults();}},set:function(key,value){if(this._validate(key,value)){this.cookies.put(key,value);}else{}},get:function(key){if(this._INTEGER_PARAMS.include(key)){return parseInt(this.cookies.get(key));}
else if(this._FLOAT_PARAMS.include(key)){return parseFloat(this.cookies.get(key));}
else if(this._BOOLEAN_PARAMS.include(key)){return this.cookies.get(key)=="true"?true:false;}
return this.cookies.get(key);},_exists:function(){return(this.cookies.getKeys().length>0);},_validate:function(setting,value){switch(setting){case"obs-date":if(isNaN(value)){return false;}
break;case"zoom-level":if((isNaN(value))||(value<this.controller.minZoomLevel)||(value>this.controller.maxZoomLevel)){return false;}
break;default:break;}
return true;},_resetSetting:function(setting){this.set(setting,this._getDefault(setting));},_getDefault:function(setting){return this._DEFAULTS.get(setting);},_loadDefaults:function(){var self=this;this._DEFAULTS.each(function(setting){self.set(setting.key,setting.value);});}});var Viewport=Class.create(UIElement,{defaultOptions:{zoomLevel:0,headerId:'middle-col-header',footerId:'footer',tileSize:512,minHeight:450,debug:false,prefetch:0},isMoving:false,dimensions:{width:0,height:0},initialize:function(controller,options){Object.extend(this,this.defaultOptions);Object.extend(this,options);var center,centerBox;this.domNode=$(this.id);this.innerNode=$(this.id+'-container-inner');this.outerNode=$(this.id+'-container-outer');this.controller=controller;this.mouseCoords="disabled";this.ViewportHandlers=new ViewportHandlers(this);this.headerAndFooterHeight=$(this.headerId).getDimensions().height+$(this.footerId).getDimensions().height+4+30;this.resize();center=this.getCenter();this.sandbox=$(this.domNode.appendChild(Builder.node('div',{id:'sandbox'})));this.sandbox.setStyle({'position':'absolute','width':'0px','height':'0px','left':center.x+'px','top':center.y+'px'});this.movingContainer=$(this.sandbox.appendChild(Builder.node('div',{id:'moving-container'})));this.movingContainer.setStyle({'left':0,'top':0});if(this.debug){this.movingContainer.setStyle({'border':'1px solid red'});centerBox=new Element('div',{id:'vp-debug-center',style:'position: absolute; width: 50px; height: 50px; border: 1px dashed red; '});centerBox.setStyle({'left':(center.x-25)+'px','top':(center.y-25)+'px'});this.domNode.insert(centerBox);}},center:function(){var sb=this.sandbox.getDimensions();this.moveTo(0.5*sb.width,0.5*sb.height);},moveTo:function(x,y){this.movingContainer.setStyle({left:x+'px',top:y+'px'});this.checkTiles();this.fire('move',{x:x,y:y});},moveBy:function(x,y){var sandbox=this.sandbox.getDimensions(),pos={x:Math.min(Math.max(this.startMovingPosition.x-x,0),sandbox.width),y:Math.min(Math.max(this.startMovingPosition.y-y,0),sandbox.height)};this.movingContainer.setStyle({left:pos.x+'px',top:pos.y+'px'});this.checkTiles();this.fire('move',{x:pos.x,y:pos.y});},startMoving:function(){this.startMovingPosition=this.getContainerPos();},getCenter:function(){return{x:Math.round(this.domNode.getWidth()/2),y:Math.round(this.domNode.getHeight()/2)};},getContainerPos:function(){return{x:parseInt(this.movingContainer.getStyle('left'),10),y:parseInt(this.movingContainer.getStyle('top'),10)};},currentPosition:function(){return this.getContainerPos();},helioCenter:function(){return this.getContainerPos();},endMoving:function(){},checkTiles:function(){var i,j,indices;this.visible=[];indices=this.displayRange();for(i=indices.xStart;i<=indices.xEnd;i+=1){for(j=indices.yStart;j<=indices.yEnd;j+=1){if(!this.visible[i]){this.visible[i]=[];}
this.visible[i][j]=true;}}},updateSandbox:function(){var maxDimensions,old,center,newSize,change,movingContainerOldPos,newHCLeft,newHCTop,padHeight,shiftTop;this.dimensions=this.domNode.getDimensions();maxDimensions=this.controller.layerManager.getMaxDimensions();old=this.sandbox.getDimensions();center=this.getCenter();newSize={width:Math.max(0,maxDimensions.width-this.dimensions.width),height:Math.max(0,maxDimensions.height-this.dimensions.height)};if(this.debug){$('vp-debug-center').setStyle({'left':center.x-25+'px','top':center.y-25+'px'});}
change={x:newSize.width-old.width,y:newSize.height-old.height};movingContainerOldPos=this.movingContainer.positionedOffset();this.sandbox.setStyle({width:newSize.width+'px',height:newSize.height+'px',left:center.x-(0.5*newSize.width)+'px',top:center.y-(0.5*newSize.height)+'px'});newHCLeft=Math.max(0,Math.min(newSize.width,movingContainerOldPos[0]+(0.5*change.x)));newHCTop=Math.max(0,Math.min(newSize.height,movingContainerOldPos[1]+(0.5*change.y)));this.movingContainer.setStyle({left:newHCLeft+'px',top:newHCTop+'px'});},displayRange:function(){var vp,ts;vp=this.getHCViewportPixelCoords();ts=this.tileSize;vp={top:vp.top-ts-(vp.top%ts),left:vp.left-ts-(vp.left%ts),bottom:vp.bottom+ts-(vp.bottom%ts),right:vp.right+ts-(vp.right%ts)};this.visibleRange={xStart:vp.left/ts,xEnd:(vp.right/ts)-1,yStart:vp.top/ts,yEnd:(vp.bottom/ts)-1};return this.visibleRange;},getHCViewportPixelCoords:function(){var sb,mc,vpDimensions;sb=this.sandbox.positionedOffset();mc=this.movingContainer.positionedOffset();vpDimensions=this.domNode.getDimensions();return{left:-(sb[0]+mc[0]),top:-(sb[1]+mc[1]),right:vpDimensions.width-(sb[0]+mc[0]),bottom:vpDimensions.height-(sb[1]+mc[1])};},zoomTo:function(zoomLevel){this.zoomLevel=zoomLevel;this.checkTiles();this.controller.layerManager.resetLayers(this.visible);this.updateSandbox();this.controller.userSettings.set('zoom-level',zoomLevel);},resize:function(){var oldDimensions,h,viewportOuter,padHeight;oldDimensions=this.dimensions;if(!jQuery('#outsideBox').hasClass('fullscreen-mode')){padHeight=this.headerAndFooterHeight;}else{padHeight=0;}
h=Math.max(this.minHeight,document.viewport.getHeight()-padHeight);viewportOuter=this.outerNode;viewportOuter.setStyle({height:h+'px'});this.dimensions=this.domNode.getDimensions();this.dimensions.width+=this.prefetch;this.dimensions.height+=this.prefetch;if(this.dimensions.width!==oldDimensions.width||this.dimensions.height!==oldDimensions.height){if(this.controller.layerManager.layers.length>0){this.updateSandbox();this.checkTiles();this.controller.layerManager.resetLayers(this.visible);}}}});var ViewportHandlers=Class.create({startingPosition:{x:0,y:0},mouseStartingPosition:{x:0,y:0},mouseCurrentPosition:{x:0,y:0},mouseCoords:{x:0,y:0},moveCounter:0,moveThrottle:2,naturalZoomLevel:10,naturalResolution:2.63,rSunArcSeconds:975,initialize:function(viewport){this.viewport=viewport;Event.observe(document,'mousemove',this.mouseMove.bindAsEventListener(this));Event.observe(document,'mouseup',this.mouseUp.bindAsEventListener(this));Event.observe(viewport.domNode,'mousedown',this.mouseDown.bindAsEventListener(this));Event.observe(this.viewport.domNode,'dblclick',this.doubleClick.bindAsEventListener(this));Event.observe(this.viewport.domNode,"mousewheel",this.mouseWheel.bindAsEventListener(this),false);Event.observe(this.viewport.domNode,"DOMMouseScroll",this.mouseWheel.bindAsEventListener(this),false);Event.observe(document,'keypress',this.keyPress.bindAsEventListener(this));Event.observe(window,'keypress',this.keyPress.bindAsEventListener(this));},mouseDown:function(event){this.viewport.isMoving=true;this.startingPosition=this.viewport.currentPosition();this.mouseStartingPosition={x:Event.pointerX(event),y:Event.pointerY(event)};this.viewport.domNode.setStyle({cursor:'all-scroll'});if(this.viewport.domNode.setCapture){this.viewport.domNode.setCapture();}
this.viewport.startMoving();},doubleClick:function(e){var pos,viewport=this.viewport;if((e.shiftKey||(viewport.zoomLevel>viewport.controller.minZoomLevel))&&(viewport.zoomLevel<viewport.controller.maxZoomLevel)){if(e.isLeftClick()){pos=this.getRelativeCoords(e.pointerX(),e.pointerY());viewport.center();this.viewport.startMoving();if(e.shiftKey){viewport.moveBy(0.5*pos.x,0.5*pos.y);viewport.controller.zoomControl.zoomButtonClicked(1);}
else{viewport.moveBy(2*pos.x,2*pos.y);viewport.controller.zoomControl.zoomButtonClicked(-1);}}}else{}},mouseWheel:function(e){this.viewport.controller.zoomControl.zoomButtonClicked(-Event.wheel(e));},getRelativeCoords:function(screenx,screeny){var vp,offset,mouseCoords;vp=this.viewport;offset=$('helioviewer-viewport-container-inner').positionedOffset();mouseCoords={x:screenx-offset[0]-1,y:screeny-offset[1]-1};return mouseCoords;},keyPress:function(e){var key=e.keyCode;if(e.target.tagName!=="INPUT"){if(key===37||key===38||key===39||key===40){this.startingPosition=this.viewport.currentPosition();this.viewport.startMoving();this.moveCounter=(this.moveCounter+1)%this.moveThrottle;if(this.moveCounter!==0){return;}
if(key===37){this.viewport.moveBy(8,0);}
else if(e.keyCode===38){this.viewport.moveBy(0,8);}
else if(e.keyCode===39){this.viewport.moveBy(-8,0);}
else if(e.keyCode===40){this.viewport.moveBy(0,-8);}}}},mouseUp:function(event){this.viewport.isMoving=false;this.viewport.domNode.setStyle({cursor:'pointer'});if(this.viewport.domNode.releaseCapture){this.viewport.domNode.releaseCapture();}
this.viewport.endMoving();},keyRelease:function(event){this.viewport.isMoving=false;this.viewport.endMoving();},mouseMove:function(event){if(!this.viewport.isMoving){return;}
var sb=this.viewport.sandbox.getDimensions();if((sb.width===0)&&(sb.height===0)){return;}
this.moveCounter=(this.moveCounter+1)%this.moveThrottle;if(this.moveCounter!==0){return;}
this.mouseCurrentPosition={x:Event.pointerX(event),y:Event.pointerY(event)};this.viewport.moveBy(this.mouseStartingPosition.x-this.mouseCurrentPosition.x,this.mouseStartingPosition.y-this.mouseCurrentPosition.y);},toggleMouseCoords:function(){var vp,mouseCoordsX,mouseCoordsY,updateMouseCoords,self=this;if(this.viewport.mouseCoords==="disabled"){this.viewport.mouseCoords="arcseconds";$('mouse-coords').toggle();}
else if(this.viewport.mouseCoords==="arcseconds"){this.viewport.mouseCoords="polar";}
else{$('mouse-coords').toggle();this.viewport.mouseCoords="disabled";}
if(this.viewport.controller.userSettings.get('warn-mouse-coords')==="false"){this.viewport.controller.messageConsole.log("Note: Mouse-coordinates should not be used for science operations!");this.viewport.controller.userSettings.set('warn-mouse-coords',true);}
if(this.viewport.mouseCoords!=="disabled"){mouseCoordsX=$('mouse-coords-x');mouseCoordsY=$('mouse-coords-y');mouseCoordsX.update("");mouseCoordsY.update("");if(this.viewport.mouseCoords==="polar"){Event.stopObserving(this.viewport.movingContainer,"mousemove");}
updateMouseCoords=function(e){var VX,negSV,SV,SM,MX,scale,x,y,polar;self.mouseCoords={x:e.pageX,y:e.pageY};self.moveCounter=(self.moveCounter+1)%self.moveThrottle;if(self.moveCounter!==0){return;}
VX=self.getRelativeCoords(e.pageX,e.pageY);negSV=self.viewport.sandbox.positionedOffset();SV={x:-negSV[0],y:-negSV[1]};SM=$('moving-container').positionedOffset();MX={x:VX.x+(SV.x-SM[0]),y:VX.y+(SV.y-SM[1])};scale=self.naturalResolution*Math.pow(2,self.viewport.zoomLevel-self.naturalZoomLevel);x=Math.round((scale*MX.x));y=-Math.round((scale*MX.y));if(self.viewport.mouseCoords==="arcseconds"){mouseCoordsX.update("x: "+x+" &prime;&prime;");mouseCoordsY.update("y: "+y+" &prime;&prime;");}else{polar=Math.toPolarCoords(x,-y);mouseCoordsX.update(((polar.r/self.rSunArcSeconds)+"").substring(0,5)+" R<span style='vertical-align: sub; font-size:10px;'>&#9737;</span>");mouseCoordsY.update(Math.round(polar.theta)+" &#176;");}};Event.observe(this.viewport.movingContainer,"mousemove",updateMouseCoords);updateMouseCoords({pageX:this.mouseCoords.x,pageY:this.mouseCoords.y});}else{Event.stopObserving(this.viewport.movingContainer,"mousemove");}}});var ZoomControl=Class.create(UIElement,{initialize:function(controller,options){Object.extend(this,options);this.controller=controller;this.domNode=$(this.id);this.handle=$(this.id+'Handle');var range=$R(this.minZoomLevel,this.maxZoomLevel);this.slider=new Control.Slider(this.handle,this.id+'Track',{axis:'vertical',values:range,sliderValue:this.zoomLevel,range:range,onChange:this.changed.bind(this)});Event.observe($(this.id+'ZoomIn'),'click',this.zoomButtonClicked.bind(this,-1));Event.observe($(this.id+'ZoomIn'),'mousedown',function(e){Event.stop(e);});Event.observe($(this.id+'ZoomOut'),'mouseup',this.zoomButtonClicked.bind(this,1));Event.observe($(this.id+'ZoomOut'),'mousedown',function(e){Event.stop(e);});},zoomButtonClicked:function(dir){this.slider.setValue(this.slider.value+dir);},changed:function(v){this.fire('change',v);}});